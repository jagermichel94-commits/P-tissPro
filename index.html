<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>P√¢tissPro ‚Äî Rentabilit√© & Gestion</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="P√¢tissPro">
<meta name="mobile-web-app-capable" content="yes">
<meta name="application-name" content="P√¢tissPro">
<meta name="format-detection" content="telephone=no">
<meta name="color-scheme" content="light dark">
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAACXBIWXMAAAsSAAALEgHS3X78AAABd0lEQVR4nO3RQREAAAjAMPp/6U0hCwqQm5k0nQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADwYz0AAVK9Y2wAAAAASUVORK5CYII=">

<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,800;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{--cream:#FAF4E8;--warm-white:#FEF9F0;--caramel:#C8873A;--cl:#E8A95C;--cd:#8B5E1A;--choc:#3D1F0A;--chocm:#6B3A1F;--mocha:#8C5E3C;--blush:#F2C8A0;--bl:#FDE8D0;--sage:#7A9E7E;--gold:#D4A843;--dang:#C0392B;--succ:#2E7D32;--sw:0 4px 24px rgba(61,31,10,.10);--sd:0 8px 40px rgba(61,31,10,.18);--r:16px;--rs:10px}

/* ====== THEME (dark mode) ====== */
body[data-theme="dark"]{
  --cream:#1b1410;
  --warm-white:#221a15;
  --bl:#2a201a;
  --blush:#3a2a22;
  --caramel:#E0A45B;
  --cl:#F0C07A;
  --cd:#C8842C;
  --choc:#F6EBDD;
  --chocm:#E8D8C5;
  --mocha:#C9B49E;
  --sage:#8FC79A;
  --gold:#F1C86A;
  --sw:0 4px 24px rgba(0,0,0,.35);
  --sd:0 10px 44px rgba(0,0,0,.55);
}





*{margin:0;padding:0;box-sizing:border-box}
body{font-family:"DM Sans",sans-serif;background:var(--cream);color:var(--choc);min-height:100vh;overflow-x:hidden}
#auth{position:fixed;inset:0;z-index:1000;background:linear-gradient(135deg,var(--choc),var(--chocm) 50%,var(--cd));display:flex;align-items:center;justify-content:center;padding:20px}
.adeco{position:absolute;top:0;left:0;right:0;font-size:70px;opacity:.05;white-space:nowrap;overflow:hidden;animation:ft 22s linear infinite;letter-spacing:20px}
@keyframes ft{from{transform:translateX(0)}to{transform:translateX(-50%)}}
.acard{background:var(--warm-white);border-radius:24px;padding:44px 40px;width:100%;max-width:430px;box-shadow:0 24px 80px rgba(0,0,0,.4);position:relative;z-index:1;animation:su .6s cubic-bezier(.16,1,.3,1)}
@keyframes su{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
.alogo{text-align:center;margin-bottom:28px}
.alogo .icon{font-size:50px;display:block;margin-bottom:6px}
.alogo h1{font-family:"Playfair Display",serif;font-size:26px;color:var(--cd);font-style:italic}
.alogo p{font-size:12px;color:var(--mocha);margin-top:3px}
.atabs{display:flex;gap:4px;background:var(--cream);border-radius:12px;padding:4px;margin-bottom:24px}
.atab{flex:1;padding:10px;border:none;border-radius:8px;font-family:"DM Sans",sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s;background:transparent;color:var(--mocha)}
.atab.active{background:var(--caramel);color:#fff}
.fg{margin-bottom:16px}
.fg label{display:block;font-size:12px;font-weight:500;color:var(--chocm);margin-bottom:5px}
.fg input{width:100%;padding:12px 15px;border:2px solid var(--blush);border-radius:var(--rs);font-family:"DM Sans",sans-serif;font-size:14px;background:var(--warm-white);color:var(--choc);transition:border-color .2s;outline:none}
.fg input:focus{border-color:var(--caramel)}
.btna{width:100%;padding:14px;background:linear-gradient(135deg,var(--caramel),var(--cd));color:#fff;border:none;border-radius:var(--rs);font-family:"DM Sans",sans-serif;font-size:15px;font-weight:600;cursor:pointer;transition:all .2s;box-shadow:0 4px 16px rgba(200,135,58,.35);margin-top:8px}
.btna:hover{transform:translateY(-1px)}
.ademo{text-align:center;margin-top:16px;font-size:12px;color:var(--mocha)}
.ademo a{color:var(--caramel);cursor:pointer;text-decoration:underline}
#app{display:none;min-height:100vh}
.sidebar{position:fixed;left:0;top:0;bottom:0;width:254px;background:var(--choc);display:flex;flex-direction:column;z-index:100;box-shadow:4px 0 24px rgba(61,31,10,.2)}
.slogo{padding:24px 20px 18px;border-bottom:1px solid rgba(255,255,255,.07)}
.slogo .sicon{font-size:28px}
.slogo h2{font-family:"Playfair Display",serif;font-size:18px;color:var(--bl);font-style:italic;margin-top:3px}
.slogo p{font-size:10px;color:rgba(255,255,255,.35);margin-top:2px}
.uinfo{padding:14px 20px;border-bottom:1px solid rgba(255,255,255,.07);display:flex;align-items:center;gap:10px}
.uav{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--caramel),var(--cd));display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:#fff;flex-shrink:0}
.uname{font-size:13px;font-weight:600;color:var(--bl);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.uplan{font-size:11px;color:rgba(255,255,255,.38)}
.snav{flex:1;padding:14px 10px;overflow-y:auto}
.nlbl{font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,.22);padding:0 10px 6px;margin-top:10px}
.ni{display:flex;align-items:center;gap:10px;padding:10px;border-radius:var(--rs);cursor:pointer;transition:all .2s;color:rgba(255,255,255,.5);font-size:13px;position:relative;margin-bottom:1px}
.ni:hover{background:rgba(255,255,255,.06);color:rgba(255,255,255,.85)}
.ni.active{background:rgba(200,135,58,.2);color:var(--cl);font-weight:500}
.ni.active::before{content:"";position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:18px;background:var(--caramel);border-radius:0 3px 3px 0}
.nico{font-size:16px;width:18px;text-align:center}
.nlock{margin-left:auto;font-size:11px;opacity:.45}
.supg{margin:10px;padding:14px;background:linear-gradient(135deg,rgba(200,135,58,.18),rgba(139,94,26,.28));border:1px solid rgba(200,135,58,.28);border-radius:var(--rs)}
.supg h4{font-size:12px;color:var(--gold);margin-bottom:5px}
.supg p{font-size:10px;color:rgba(255,255,255,.45);margin-bottom:10px;line-height:1.5}
.btnupg{width:100%;padding:8px;background:linear-gradient(135deg,var(--gold),var(--caramel));color:#fff;border:none;border-radius:7px;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s}
.btnupg:hover{opacity:.9;transform:translateY(-1px)}
.mc{margin-left:254px;min-height:100vh;padding:28px;position:relative;z-index:1}
.page{display:none}
.page.active{display:block;animation:fi .3s ease}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.ph{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:28px}
.ph h2{font-family:"Playfair Display",serif;font-size:28px;color:var(--choc);font-style:italic}
.ph p{font-size:13px;color:var(--mocha);margin-top:3px}
.card{background:var(--warm-white);border-radius:var(--r);padding:22px;box-shadow:var(--sw);border:1px solid rgba(200,135,58,.08)}
.cg{display:grid;gap:18px}
.g2{grid-template-columns:repeat(2,1fr)}
.g3{grid-template-columns:repeat(3,1fr)}
.g4{grid-template-columns:repeat(4,1fr)}
.kpi{background:var(--warm-white);border-radius:var(--r);padding:18px 22px;box-shadow:var(--sw);border:1px solid rgba(200,135,58,.1);transition:transform .2s;position:relative}
.kpi:hover{transform:translateY(-2px)}
.klbl{font-size:11px;font-weight:500;color:var(--mocha);text-transform:uppercase;letter-spacing:.5px}
.kval{font-size:26px;font-weight:700;color:var(--choc);margin:7px 0 3px;font-family:"Playfair Display",serif}
.ksub{font-size:11px;color:var(--sage)}
.kico{position:absolute;top:18px;right:18px;font-size:22px;opacity:.6}
.pos{color:var(--succ)!important}
.neg{color:var(--dang)!important}
.cc{position:relative;width:100%;height:210px}
canvas{max-width:100%}
table{width:100%;border-collapse:collapse}
th{text-align:left;padding:11px 14px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--mocha);border-bottom:2px solid var(--blush);background:var(--cream)}
td{padding:12px 14px;font-size:13px;border-bottom:1px solid rgba(200,135,58,.07);color:var(--choc)}
tr:hover td{background:rgba(200,135,58,.025)}
.tdb{font-weight:600}
.tw{overflow-x:auto}
.ig{display:flex;flex-direction:column;gap:5px}
.ig label{font-size:12px;font-weight:500;color:var(--chocm)}
.ig input,.ig select,.ig textarea{padding:10px 13px;border:2px solid var(--blush);border-radius:var(--rs);font-family:"DM Sans",sans-serif;font-size:13px;background:var(--warm-white);color:var(--choc);transition:border-color .2s;outline:none;width:100%}
.ig input:focus,.ig select:focus{border-color:var(--caramel)}
.fr{display:grid;gap:14px}
.fr2{grid-template-columns:1fr 1fr}
.fr3{grid-template-columns:1fr 1fr 1fr}
.btn{padding:9px 18px;border-radius:var(--rs);border:none;font-family:"DM Sans",sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:7px}
.btnp{background:var(--caramel);color:#fff;box-shadow:0 2px 8px rgba(200,135,58,.28)}
.btnp:hover{background:var(--cd)}
.btno{background:transparent;color:var(--caramel);border:2px solid var(--caramel)}
.btno:hover{background:var(--bl)}
.btnd{background:var(--dang);color:#fff}
.bsm{padding:6px 12px;font-size:11px}
.tag{display:inline-flex;align-items:center;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:500}
.tg{background:rgba(46,125,50,.1);color:var(--succ)}
.tr{background:rgba(192,57,43,.1);color:var(--dang)}
.to{background:rgba(200,135,58,.14);color:var(--cd)}
.pb{height:7px;background:var(--bl);border-radius:4px;overflow:hidden;margin-top:4px}
.pf{height:100%;border-radius:4px;background:linear-gradient(90deg,var(--caramel),var(--gold));transition:width .5s ease}
.st{font-family:"Playfair Display",serif;font-size:17px;color:var(--choc);margin-bottom:14px;padding-bottom:9px;border-bottom:2px solid var(--blush);display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px}
.ir{display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid var(--bl)}
.ir input,.ir select{padding:7px 9px;border:1.5px solid var(--blush);border-radius:7px;font-size:12px;background:var(--cream);color:var(--choc);font-family:"DM Sans",sans-serif;outline:none;width:100%}
.ir input:focus,.ir select:focus{border-color:var(--caramel)}
.btnrm{background:rgba(192,57,43,.1);color:var(--dang);border:none;width:30px;height:30px;border-radius:7px;cursor:pointer;font-size:15px;transition:background .2s;flex-shrink:0}
.btnrm:hover{background:rgba(192,57,43,.2)}
.mo{position:fixed;inset:0;background:rgba(61,31,10,.6);z-index:500;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(4px)}
.mo.open{display:flex}
.md{background:var(--warm-white);border-radius:20px;padding:28px;max-width:580px;width:100%;box-shadow:0 24px 80px rgba(0,0,0,.25);animation:su .3s ease;max-height:90vh;overflow-y:auto}
.mh{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.mh h3{font-family:"Playfair Display",serif;font-size:20px;font-style:italic}
.mclose{background:var(--cream);border:none;width:34px;height:34px;border-radius:50%;cursor:pointer;font-size:17px;color:var(--mocha);transition:background .2s}
.mclose:hover{background:var(--blush)}
.notif{position:fixed;top:22px;right:22px;z-index:2000;padding:13px 18px;border-radius:var(--rs);background:var(--choc);color:#fff;font-size:13px;font-weight:500;box-shadow:var(--sd);transform:translateX(130%);transition:transform .3s cubic-bezier(.16,1,.3,1);display:flex;align-items:center;gap:9px;max-width:300px}
.notif.show{transform:translateX(0)}
.notif.ns{background:var(--succ)}
.notif.ne{background:var(--dang)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--blush);border-radius:3px}
.sm{display:flex;align-items:center;gap:14px;padding:13px 18px;background:var(--cream);border-radius:var(--rs);border-left:4px solid var(--caramel)}
.smi{font-size:22px}
.smv{font-size:18px;font-weight:700;color:var(--choc)}
.sml{font-size:11px;color:var(--mocha)}
.rcc{background:var(--warm-white);border-radius:var(--r);padding:18px;box-shadow:var(--sw);border:1px solid rgba(200,135,58,.1);cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.rcc::before{content:"";position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--caramel),var(--gold))}
.rcc:hover{transform:translateY(-2px);box-shadow:var(--sd)}
.rcc h4{font-family:"Playfair Display",serif;font-size:16px;margin-bottom:7px;padding-top:4px}
.rr{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;font-size:12px}
.rl{color:var(--mocha)}
.rv{font-weight:600}
.ec{display:flex;align-items:center;gap:14px;padding:14px;background:var(--warm-white);border-radius:var(--rs);border:1px solid rgba(200,135,58,.1);margin-bottom:8px}
.eav{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--blush),var(--cl));display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:var(--cd);flex-shrink:0}
.ei{flex:1}
.en{font-weight:600;font-size:14px}
.er{font-size:11px;color:var(--mocha)}
.es{text-align:right;margin-right:8px}
.eh{font-size:14px;font-weight:700;color:var(--cd)}
.ec2{font-size:11px;color:var(--mocha)}
.vr{display:flex;align-items:center;gap:14px;padding:11px 0;border-bottom:1px solid var(--bl)}
.vi{flex:1}
.vn{font-weight:600;font-size:13px}
.vd{font-size:11px;color:var(--mocha)}
.va{font-size:15px;font-weight:700;color:var(--succ)}
.sal{display:flex;align-items:center;gap:10px;padding:11px 14px;border-radius:var(--rs);background:rgba(192,57,43,.07);border-left:3px solid var(--dang);margin-bottom:8px}
.alt{font-size:12px;color:var(--choc)}
.tsw{display:flex;gap:4px;background:var(--cream);border-radius:11px;padding:4px;margin-bottom:20px;width:fit-content}
.tbtn{padding:7px 16px;border:none;border-radius:7px;font-family:"DM Sans",sans-serif;font-size:12px;font-weight:500;cursor:pointer;transition:all .2s;background:transparent;color:var(--mocha)}
.tbtn.active{background:var(--caramel);color:#fff;box-shadow:0 2px 8px rgba(200,135,58,.22)}
.pcg{display:grid;grid-template-columns:repeat(2,1fr);gap:18px;margin-top:18px}
.pc{border-radius:var(--r);padding:24px;border:2px solid var(--blush);background:var(--warm-white);transition:all .2s}
.pc.feat{border-color:var(--caramel);background:linear-gradient(160deg,var(--warm-white),var(--bl));box-shadow:var(--sd)}
.pcp{font-family:"Playfair Display",serif;font-size:34px;color:var(--cd);margin:10px 0 3px}
.pcp span{font-size:15px;font-family:"DM Sans",sans-serif;color:var(--mocha)}
.pcf{list-style:none;margin:14px 0 20px}
.pcf li{padding:5px 0;font-size:12px;color:var(--chocm);display:flex;gap:7px;align-items:flex-start}
.pcf li::before{content:"‚úì";color:var(--sage);font-weight:700;flex-shrink:0}
.pcf li.lk::before{content:"‚úó";color:rgba(0,0,0,.2)}
.pcf li.lk{opacity:.5}
@media(max-width:1024px){.g4{grid-template-columns:repeat(2,1fr)}.g3{grid-template-columns:repeat(2,1fr)}}
@media(max-width:768px){.sidebar{transform:translateX(-100%)}.mc{margin-left:0;padding:16px}.g2,.g3,.g4,.fr2,.fr3,.pcg{grid-template-columns:1fr}}

.logout-btn{
  width:calc(100% - 20px);
  margin:10px;
  background:transparent;
  color:#fff;
  border:1.5px solid rgba(255,255,255,.25);
}
.logout-btn:hover{
  background:rgba(255,255,255,.08);
}


/* === SIDEBAR COMPACT MODE === */
.supg{
  margin:8px;
  padding:10px;
  border-radius:10px;
  font-size:11px;
}
.supg h4{
  font-size:11px;
  margin-bottom:3px;
}
.supg p{
  font-size:9px;
  margin-bottom:6px;
  line-height:1.3;
}
.btnupg{
  padding:6px;
  font-size:10px;
}

.theme-toggle{
  font-size:11px;
  padding:6px 8px;
  margin:6px 8px;
  border-radius:8px;
}

.nico{
  font-size:14px;
  width:16px;
}
.ni{
  padding:8px;
  font-size:12px;
}



.srow{display:flex;gap:10px;align-items:center;padding:10px 12px;border-radius:12px;background:var(--warm-white);border:1px solid rgba(200,135,58,.12);margin-bottom:8px;cursor:pointer;transition:transform .15s, box-shadow .15s}
.srow:hover{transform:translateY(-1px);box-shadow:0 8px 22px rgba(61,31,10,.10)}
.sbadge{font-size:10px;font-weight:700;letter-spacing:.3px;text-transform:uppercase;padding:4px 8px;border-radius:999px;background:rgba(200,135,58,.14);color:var(--cd);flex-shrink:0}
.stitle{font-weight:700;font-size:13px}
.smeta{font-size:11px;color:var(--mocha);margin-top:2px}



:root{
  color-scheme: light dark;
}

/* Smooth theme transition */
html, body, .card, .kpi, .rcc, .sidebar, .mc, .md, .ni, .supg, input, select, textarea, table, th, td, .notif {
  transition: background-color .22s ease, color .22s ease, border-color .22s ease, box-shadow .22s ease, transform .18s ease;
}

/* Use a data-theme flag on <html> (already used by JS) */


/* Background glow */


/* Sidebar premium */





/* Cards look like native app panels */


/* Tables */




/* Inputs */



/* Pills / tags */




/* Notif */


/* Canvas/charts: slight boost contrast in dark */


/* Safe-area padding for iOS (store feel) */
.mc{ padding-top: calc(28px + env(safe-area-inset-top)); padding-bottom: calc(28px + env(safe-area-inset-bottom)); }
.sidebar{ padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }

/* App-like topbar shadow on header sections */
.ph{
  position: sticky;
  top: 0;
  z-index: 50;
  padding-top: 14px;
  padding-bottom: 14px;
  backdrop-filter: blur(10px);
  background: linear-gradient(180deg, rgba(250,244,232,.82), rgba(250,244,232,.55));
  border-bottom: 1px solid rgba(200,135,58,.10);
}



/* === SUPG COMPACT === */
.supg{
  margin:6px;
  padding:8px;
  border-radius:10px;
  font-size:10px;
}
.supg h4{
  font-size:10px;
  margin-bottom:2px;
}
.supg p{
  font-size:8.5px;
  margin-bottom:5px;
  line-height:1.25;
}
.btnupg{
  padding:5px 6px;
  font-size:9px;
  border-radius:8px;
}


/* === SUPG ULTRA DISCRET === */
.supg{
  margin:4px;
  padding:6px;
  border-radius:8px;
  font-size:9px;
  background:rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.06);
  box-shadow:none;
  opacity:0.75;
}
.supg:hover{
  opacity:1;
}
.supg h4{
  font-size:9px;
  margin-bottom:2px;
  opacity:0.85;
}
.supg p{
  font-size:8px;
  margin-bottom:4px;
  line-height:1.2;
  opacity:0.75;
}
.btnupg{
  padding:4px 5px;
  font-size:8px;
  border-radius:6px;
  background:rgba(200,135,58,0.15);
  border:1px solid rgba(200,135,58,0.25);
  box-shadow:none;
}
.btnupg:hover{
  background:rgba(200,135,58,0.25);
}


/* === RESPONSIVE (mobile store-ready) === */
.mtop{display:none}
.sbover{display:none}

@media (max-width: 768px){
  /* topbar */
  .mtop{
    display:flex;
    position:fixed;
    top:0; left:0; right:0;
    height:56px;
    padding:0 10px;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    z-index:300;
    background:linear-gradient(180deg, rgba(254,249,240,.92), rgba(250,244,232,.78));
    backdrop-filter: blur(10px);
    border-bottom:1px solid rgba(200,135,58,.14);
  }
  
  .mbtn{
    width:40px;height:40px;
    border:none;border-radius:12px;
    background:rgba(200,135,58,.14);
    color:var(--choc);
    font-size:18px;
    display:flex;align-items:center;justify-content:center;
  }
  
  .mtitle{display:flex;align-items:center;gap:8px;min-width:0}
  .micon{font-size:20px}
  .mname{
    font-family:"Playfair Display",serif;
    font-style:italic;
    font-size:16px;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }

  /* main content under topbar */
  .mc{margin-left:0;padding:14px;padding-top:72px}
  .ph{position:relative;top:auto;padding-top:0;background:transparent;backdrop-filter:none;border-bottom:none}

  /* sidebar becomes drawer */
  .sidebar{
    transform:translateX(-100%);
    transition:transform .25s cubic-bezier(.16,1,.3,1);
    width:280px;
    z-index:600;
  }
  .sidebar.open{transform:translateX(0)}
  .sbover{
    display:block;
    position:fixed;inset:0;
    background:rgba(0,0,0,.45);
    z-index:550;
    opacity:0;
    pointer-events:none;
    transition:opacity .2s ease;
  }
  .sbover.show{
    opacity:1;
    pointer-events:auto;
  }

  /* grids tighter */
  .g2,.g3,.g4,.fr2,.fr3,.pcg{grid-template-columns:1fr}
  .cg{gap:12px}
  .card{padding:16px}
  .kpi{padding:14px 16px}
  .kval{font-size:22px}

  /* tables scroll */
  .tw{overflow-x:auto;-webkit-overflow-scrolling:touch}
  table{min-width:720px}
}

/* Slightly nicer responsive for tablets */
@media (max-width: 1024px){
  .mc{padding:18px}
}


/* === FIX BOUTON "SAISIR UNE VENTE" SUR MOBILE === */
@media (max-width: 768px){
  .ph .btn.btnp{
    margin-top: 9.5mm; /* ajuste ici si besoin */
  }
}

</style>



</head>
<body data-theme="light">

<!-- AUTH -->
<div id="auth">
  <div class="adeco">ü•êüéÇüç∞üßÅü•ßüçÆüéÇü•êüç∞üßÅü•êüéÇüç∞üßÅü•ßüçÆüéÇü•êüç∞üßÅ</div>
  <div class="acard">
    <div class="alogo">
      <span class="icon">ü•ê</span>
      <h1>P√¢tissPro</h1>
      <p>Rentabilit√© & Gestion pour artisans ambitieux</p><p style="margin-top:8px;font-size:11px;color:var(--mocha)">‚úÖ Mode D√©mo (offline) ‚Äî fonctionne sans internet</p>
    </div>
    <div class="atabs">
      <button class="atab active" onclick="switchTab('login')">Se connecter</button>
      <button class="atab" onclick="switchTab('register')">Cr√©er un compte</button>
    </div>
    <div id="lform">
      <div class="fg"><label>Email</label><input type="email" id="lemail" placeholder="vous@patisserie.fr" value="demo@patisserie.fr"></div>
      <div class="fg"><label>Mot de passe</label><input type="password" id="lpwd" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="demo1234"></div>
      <button class="btna" id="btn-login">Se connecter</button>
    </div>
    <div id="rform" style="display:none">
      <div class="fg"><label>Nom de votre p√¢tisserie</label><input type="text" id="rshop" placeholder="La Maison Sucr√©e"></div>
      <div class="fg"><label>Votre pr√©nom</label><input type="text" id="rname" placeholder="Marie"></div>
      <div class="fg"><label>Email</label><input type="email" id="remail" placeholder="vous@patisserie.fr"></div>
      <div class="fg"><label>Mot de passe</label><input type="password" id="rpwd" placeholder="Min. 8 caract√®res"></div>
      <button class="btna" id="btn-register">Cr√©er mon compte gratuit</button>
    </div>
    <div class="ademo">D√©mo rapide : <a id="btn-demo">Connexion sans inscription</a></div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- Mobile topbar -->
  <div id="mtop" class="mtop">
    <button id="btn-menu" class="mbtn" aria-label="Ouvrir le menu">‚ò∞</button>
    <div class="mtitle">
      <span class="micon">ü•ê</span>
      <span class="mname">P√¢tissPro</span>
    </div>
    <button id="btn-msearch" class="mbtn" aria-label="Rechercher">üîé</button>
  </div>
  <div id="sbover" class="sbover"></div>

  <nav class="sidebar">
    <div class="slogo">
      <span class="sicon">ü•ê</span>
      <h2>P√¢tissPro</h2>
      <p>Tableau de bord rentabilit√©</p>
    </div>
    <div class="uinfo">
      <div class="uav" id="uav">P</div>
      <div>
        <div class="uname" id="uname">P√¢tissier</div>
        <div class="uplan" id="uplan">Plan Gratuit</div>
      </div>
    </div>
    <div class="snav">
      <div class="nlbl">Principal</div>
      <div class="ni active" data-page="dashboard"><span class="nico">üìä</span> Tableau de bord</div>
      <div class="ni" data-page="recettes"><span class="nico">üìã</span> Recettes & Co√ªts</div>
      <div class="ni" data-page="prix"><span class="nico">üè∑Ô∏è</span> Calcul de Prix</div>
      <div class="ni" data-page="ventes"><span class="nico">üí∞</span> Ventes & CA</div>
      <div class="nlbl">Gestion</div>
      <div class="ni" data-page="stocks"><span class="nico">üì¶</span> Stocks</div>
      <div class="ni" data-page="employes"><span class="nico">üë•</span> Employ√©s</div>
      <div class="nlbl">Premium</div>
      <div class="ni" data-page="rapports"><span class="nico">üìà</span> Rapports avanc√©s <span class="nlock" id="lock-r">üîí</span></div>
      <div class="ni" data-page="previsions"><span class="nico">üîÆ</span> Pr√©visions IA <span class="nlock" id="lock-p">üîí</span></div>
      <div class="ni" data-page="abonnement"><span class="nico">üëë</span> Mon abonnement</div>
    </div>
    <div class="supg" id="supg">
      <h4>‚ú® Passez √† Pro</h4>
      <p>Rapports, pr√©visions IA, exports illimit√©s.</p>
      <button class="btnupg" data-page="abonnement">Voir les offres ‚Üí</button>
    
    </div>
  

<div style="padding:0 10px 10px">
  <button id="btn-about" class="btn btno" style="width:calc(100% - 0px);border-color:rgba(255,255,255,.18);color:#fff">
    ‚ÑπÔ∏è √Ä propos
  </button>
  <div style="margin-top:8px;font-size:10px;color:rgba(255,255,255,.30);padding:0 6px">
    Version d√©mo ¬∑ v1.0 ¬∑ Offline
  </div>
</div>

<button id="btn-logout" class="btn btno logout-btn">
  ‚éã D√©connexion
</button>

</nav>

  <div class="mc">
    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="ph"><div><h2>Bonjour, <span id="gname">Chef</span> üëã</h2>
      <p>Aper√ßu de votre activit√©</p></div><button class="btn btnp" data-modal="mv">+ Saisir une vente</button></div>
      <div class="cg g4" style="margin-bottom:20px">
        <div class="kpi"><span class="kico">üí∂</span><div class="klbl">CA Ce Mois</div><div class="kval" id="kca">‚Äî</div><div class="ksub pos">‚Üë +8.3% vs mois dernier</div></div>
        <div class="kpi"><span class="kico">üìà</span><div class="klbl">Marge Brute</div><div class="kval" id="kmarge">‚Äî</div><div class="ksub pos">‚Üë Bonne sant√©</div></div>
        <div class="kpi"><span class="kico">üßà</span><div class="klbl">Co√ªt Mati√®res</div><div class="kval" id="kcout">‚Äî</div><div class="ksub neg">‚Üì -2.1%</div></div>
        <div class="kpi"><span class="kico">üéÇ</span><div class="klbl">Produits Actifs</div><div class="kval" id="kprod">‚Äî</div><div class="ksub">Recettes catalogue</div></div>
      </div>
      <div class="cg g2" style="margin-bottom:20px">
        <div class="card"><div class="st">üèÜ Top Produits Rentables</div><div id="toplist"></div></div>
        <div class="card"><div class="st">‚ö†Ô∏è Alertes Stock</div><div id="alertlist"></div></div>
      </div>
      <div class="card"><div class="st">üìä √âvolution du CA ‚Äî 6 mois <span class="tag to" id="chartlbl"></span></div><div class="cc"><canvas id="caChart"></canvas></div></div>
    </div>

    <!-- RECETTES -->
    <div class="page" id="page-recettes">
      <div class="ph"><div><h2>Recettes & Co√ªts</h2><p>Calculez le co√ªt de production exact</p></div><button class="btn btnp" id="btn-new-recette">+ Nouvelle recette</button></div>
      <div class="cg g3" id="rgrid" style="margin-bottom:24px"></div>
      <div class="card">
        <div class="st">üßÆ Calculatrice de Co√ªt en Direct</div>
        <div style="background:var(--cream);border-radius:12px;padding:18px;margin-bottom:16px">
          <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:8px;font-size:11px;font-weight:600;color:var(--mocha);padding-bottom:8px"><span>Ingr√©dient</span><span>Quantit√©</span><span>Unit√©</span><span>Prix/kg ou L</span><span></span></div>
          <div id="ingc"></div>
          <button class="btn btno bsm" style="margin-top:12px" id="btn-add-ing">+ Ajouter un ingr√©dient</button>
        </div>
        <div class="fr fr3" style="margin-bottom:16px">
          <div class="ig"><label>Nombre de pi√®ces</label><input type="number" id="npieces" value="12" min="1"></div>
          <div class="ig"><label>Temps de travail (min)</label><input type="number" id="ttravail" value="60" min="0"></div>
          <div class="ig"><label>Co√ªt horaire MO (‚Ç¨)</label><input type="number" id="couth" value="18" min="0" step="0.5"></div>
        </div>
        <div class="cg g4">
          <div class="sm"><span class="smi">üßà</span><div><div class="smv" id="rmat">0,00 ‚Ç¨</div><div class="sml">Co√ªt mati√®res</div></div></div>
          <div class="sm"><span class="smi">üëê</span><div><div class="smv" id="rmo">0,00 ‚Ç¨</div><div class="sml">Main d'≈ìuvre</div></div></div>
          <div class="sm"><span class="smi">üì¶</span><div><div class="smv" id="rpc">0,00 ‚Ç¨</div><div class="sml">Co√ªt / pi√®ce</div></div></div>
          <div class="sm"><span class="smi">üí°</span><div><div class="smv" id="rsug">0,00 ‚Ç¨</div><div class="sml">Prix sugg√©r√© (√ó3)</div></div></div>
        </div>
      </div>
    </div>

    <!-- PRIX -->
    <div class="page" id="page-prix">
      <div class="ph"><div><h2>Calcul de Prix de Vente</h2><p>D√©finissez vos prix selon votre marge</p></div></div>
      <div class="cg g2" style="margin-bottom:20px">
        <div class="card">
          <div class="st">üí° Calculatrice de Marge</div>
          <div style="display:flex;flex-direction:column;gap:14px">
            
            <div class="ig">
              <label>Recette (pr√©-remplir le co√ªt)</label>
              <select id="prrec">
                <option value="">‚Äî Choisir une recette ‚Äî</option>
              </select>
            </div>

            <div class="ig"><label>Co√ªt de revient total (‚Ç¨)</label><input type="number" id="pcout" placeholder="0.00" step="0.01"></div>
            <div class="ig">
              <label>Marge souhait√©e : <strong id="margev" style="color:var(--cd)">60%</strong></label>
              <input type="range" id="pmarge" min="10" max="85" value="60" style="width:100%;accent-color:var(--caramel)">
            </div>
            <div class="ig"><label>TVA</label>
              <select id="ptva">
                <option value="5.5">5,5% ‚Äî p√¢tisserie √† emporter</option>
                <option value="10">10% ‚Äî restauration sur place</option>
                <option value="20">20% ‚Äî standard</option>
              </select>
            </div>
          </div>
          <div style="background:var(--cream);border-radius:12px;padding:18px;margin-top:18px">
            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--bl);font-size:13px"><span>Prix HT</span><strong id="rht">‚Äî ‚Ç¨</strong></div>
            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--bl);font-size:13px"><span>Montant TVA</span><strong id="rtva">‚Äî ‚Ç¨</strong></div>
            <div style="display:flex;justify-content:space-between;padding:10px 0;font-size:18px;font-weight:700;color:var(--cd)"><span>Prix TTC</span><strong id="rttc">‚Äî ‚Ç¨</strong></div>
            <div style="display:flex;justify-content:space-between;padding:7px 0;font-size:12px;color:var(--succ)"><span>Marge nette / unit√©</span><strong id="rmn">‚Äî ‚Ç¨</strong></div>
          </div>
        </div>
        <div class="card">
          <div class="st">üìâ Seuil de Rentabilit√©</div>
          <div style="display:flex;flex-direction:column;gap:14px">
            <div class="ig"><label>Charges fixes mensuelles (‚Ç¨)</label><input type="number" id="srfix" value="2500"></div>
            <div class="ig"><label>Charges variables / vente (‚Ç¨)</label><input type="number" id="srvar" value="1.80" step="0.01"></div>
            <div class="ig"><label>Prix de vente unitaire (‚Ç¨)</label><input type="number" id="srpv" value="4.50" step="0.01"></div>
          </div>
          <div style="background:linear-gradient(135deg,var(--cream),var(--bl));border-radius:12px;padding:22px;margin-top:18px;text-align:center">
            <div style="font-size:11px;color:var(--mocha);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px">Vous devez vendre au minimum</div>
            <div style="font-family:'Playfair Display',serif;font-size:50px;color:var(--cd);font-style:italic" id="seuilv">‚Äî</div>
            <div style="font-size:13px;color:var(--mocha)">pi√®ces / mois pour √™tre rentable</div>
            <div style="margin-top:10px;font-size:12px">soit <strong id="seuilca" style="color:var(--cd)">‚Äî</strong> de CA mensuel</div>
          </div>
        </div>
      </div>
      <div class="card">
        <div class="st">üìä Simulation de Rentabilit√© par Produit</div>
        <div class="tw"><table><thead><tr><th>Produit</th><th>Co√ªt unit.</th><th>Prix vente</th><th>Marge %</th><th>Marge ‚Ç¨</th><th>Vol./mois</th><th>CA mensuel</th><th>Statut</th></tr></thead><tbody id="prixtb"></tbody></table></div>
      </div>
    </div>

    <!-- VENTES -->
    <div class="page" id="page-ventes">
      <div class="ph"><div><h2>Ventes & Chiffre d'Affaires</h2><p>Suivi en temps r√©el</p></div><button class="btn btnp" data-modal="mv">+ Enregistrer une vente</button></div>
      <div class="cg g4" style="margin-bottom:20px">
        <div class="kpi"><div class="klbl">CA Aujourd'hui</div><div class="kval" id="vtoday">‚Äî</div><div class="ksub">Trans. : <span id="vnb">0</span></div></div>
        <div class="kpi"><div class="klbl">CA Cette Semaine</div><div class="kval" id="vweek">‚Äî</div><div class="ksub pos">‚Üë Bonne semaine</div></div>
        <div class="kpi"><div class="klbl">CA Ce Mois</div><div class="kval" id="vmonth">‚Äî</div><div class="ksub">Objectif : 15 000 ‚Ç¨</div></div>
        <div class="kpi"><div class="klbl">Panier Moyen</div><div class="kval" id="vpanier">‚Äî</div><div class="ksub">par transaction</div></div>
      </div>
      <div class="cg g2">
        <div class="card"><div class="st">üìã Derni√®res Ventes</div><div id="vlist"></div></div>
        <div class="card"><div class="st">ü•ß R√©partition par Produit</div><div class="cc" style="height:260px"><canvas id="vChart"></canvas></div></div>
      </div>
    </div>

    <!-- STOCKS -->
    <div class="page" id="page-stocks">
      <div class="ph"><div><h2>Gestion des Stocks</h2><p>Contr√¥lez vos ingr√©dients</p></div><button class="btn btnp" id="btn-add-stock">+ Ajouter un ingr√©dient</button></div>
      <div class="cg g3" style="margin-bottom:20px">
        <div class="kpi"><span class="kico">üí∞</span><div class="klbl">Valeur du Stock</div><div class="kval" id="stval">‚Äî</div><div class="ksub">Total mati√®res</div></div>
        <div class="kpi"><span class="kico">üö®</span><div class="klbl">Alertes Critiques</div><div class="kval neg" id="stal">‚Äî</div><div class="ksub neg">√Ä commander</div></div>
        <div class="kpi"><span class="kico">üì¶</span><div class="klbl">Articles Suivis</div><div class="kval" id="sttot">‚Äî</div><div class="ksub">Ingr√©dients</div></div>
      </div>
      <div class="card">
        <div class="st">üì¶ Inventaire Complet</div>
        <div class="tw"><table><thead><tr><th>Ingr√©dient</th><th>Cat√©gorie</th><th>Stock actuel</th><th>Seuil mini</th><th>Prix/unit√©</th><th>Valeur</th><th>Statut</th><th>Actions</th></tr></thead><tbody id="sttb"></tbody></table></div>
      </div>
    </div>

    <!-- EMPLOYES -->
    <div class="page" id="page-employes">
      <div class="ph"><div><h2>Gestion des Employ√©s</h2><p>Heures, co√ªts et planning</p></div><button class="btn btnp" data-modal="me">+ Ajouter un employ√©</button></div>
      <div class="cg g3" style="margin-bottom:20px">
        <div class="kpi"><span class="kico">üíº</span><div class="klbl">Masse Salariale</div><div class="kval" id="emasse">‚Äî</div><div class="ksub">Charges incluses</div></div>
        <div class="kpi"><span class="kico">‚è∞</span><div class="klbl">Total Heures/Mois</div><div class="kval" id="ehm">‚Äî</div><div class="ksub">Tous employ√©s</div></div>
        <div class="kpi"><span class="kico">üí°</span><div class="klbl">Co√ªt/Heure Moyen</div><div class="kval" id="echm">‚Äî</div><div class="ksub">Charg√©</div></div>
      </div>
      <div class="cg g2">
        <div class="card"><div class="st">üë• √âquipe</div><div id="elist"></div></div>
        <div class="card">
          <div class="st">‚è±Ô∏è Saisir les Heures</div>
          <div style="display:flex;flex-direction:column;gap:14px">
            <div class="ig"><label>Employ√©</label><select id="semp"><option value="">S√©lectionner...</option></select></div>
            <div class="fr fr2">
              <div class="ig"><label>Date</label><input type="date" id="sdate"></div>
              <div class="ig"><label>Heures</label><input type="number" id="sheures" placeholder="7.5" step="0.5" min="0" max="16"></div>
            </div>
            <div class="ig"><label>Type</label><select id="stype"><option>Normal</option><option>Heures sup</option><option>Cong√©s pay√©s</option><option>Maladie</option></select></div>
            <button class="btn btnp" id="btn-saisir-h">‚úì Enregistrer les heures</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RAPPORTS -->
    <div class="page" id="page-rapports">
      <div class="ph"><div><h2>Rapports Avanc√©s</h2><p>Analyses d√©taill√©es et exports</p></div></div>
      <div id="rapc"></div>
    </div>

    <!-- PREVISIONS -->
    <div class="page" id="page-previsions">
      <div class="ph"><div><h2>Pr√©visions IA</h2><p>Anticipez vos ventes et optimisez votre production</p></div></div>
      <div id="prevc"></div>
    </div>

    <!-- ABONNEMENT -->
    <div class="page" id="page-abonnement">
      <div class="ph"><div><h2>Mon Abonnement</h2><p>G√©rez votre plan</p></div></div>
      <div class="card" style="margin-bottom:22px;background:linear-gradient(135deg,var(--cream),var(--bl));border:2px solid var(--caramel)">
        <div style="display:flex;align-items:center;gap:16px">
          <span style="font-size:38px">üëë</span>
          <div>
            <h3 style="font-family:'Playfair Display',serif;font-size:19px;font-style:italic">Plan actuel : <span id="planname">Gratuit</span></h3>
            <p style="color:var(--mocha);font-size:13px;margin-top:3px" id="plandesc">Acc√®s aux fonctionnalit√©s essentielles.</p>
          </div>
        </div>
      </div>
      <div class="pcg">
        <div class="pc">
          <h3 style="font-size:15px;font-weight:700;margin-bottom:6px">ü•ê Plan Gratuit</h3>
          <div class="pcp">0 ‚Ç¨ <span>/ mois</span></div>
          <ul class="pcf">
            <li>Tableau de bord complet</li><li>Jusqu'√† 5 recettes</li><li>Calcul de prix & marge</li>
            <li>Saisie de ventes</li><li>Gestion stock basique</li>
            <li class="lk">Rapports avanc√©s & exports</li><li class="lk">Pr√©visions IA</li><li class="lk">Employ√©s illimit√©s</li>
          </ul>
          <button class="btn btno" style="width:100%" id="btn-free">Plan actuel</button>
        </div>
        <div class="pc feat">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <h3 style="font-size:15px;font-weight:700">üéÇ Plan Pro</h3>
            <span class="tag to" style="font-size:10px;font-weight:700">POPULAIRE</span>
          </div>
          <div class="pcp">30 ‚Ç¨ <span>/ mois</span></div>
          <ul class="pcf">
            <li>Tout du plan Gratuit</li><li>Recettes & employ√©s illimit√©s</li><li>Rapports avanc√©s complets</li>
            <li>Pr√©visions IA des ventes</li><li>Export PDF optimis√©</li><li>Support prioritaire</li><li>Sync cloud</li>
          </ul>
          <button class="btn btnp" style="width:100%;padding:13px;font-size:14px" id="btn-pro">‚ú® Passer √† Pro ‚Äî 30 ‚Ç¨/mois</button>
          <p style="text-align:center;font-size:11px;color:var(--mocha);margin-top:8px">Sans engagement ¬∑ 14 jours gratuits</p>
        </div>
      </div>
    </div>
  </div>
</div>



<!-- MODALS -->
<div class="mo" id="mr">
  <div class="md">
    <div class="mh"><h3>üìã Nouvelle Recette</h3><button class="mclose" data-close="mr">‚úï</button></div>
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="fr fr2">
        <div class="ig"><label>Nom *</label><input type="text" id="rnom" placeholder="Ex: Tarte au citron"></div>
        <div class="ig"><label>Cat√©gorie</label><select id="rcat"><option>Tartes</option><option>Entremets</option><option>Viennoiseries</option><option>Petits fours</option><option>Cakes</option><option>Autre</option></select></div>
      </div>
      <div class="fr fr2">
        <div class="ig"><label>Co√ªt mati√®res total (‚Ç¨)</label><input type="number" id="rcout" placeholder="0.00" step="0.01"></div>
        <div class="ig"><label>Nombre de portions</label><input type="number" id="rport" placeholder="8" min="1"></div>
      </div>
      <div class="fr fr2">
        <div class="ig"><label>Temps de production (min)</label><input type="number" id="rtps" placeholder="90" min="0"></div>
        <div class="ig"><label>Prix de vente (‚Ç¨)</label><input type="number" id="rpv" placeholder="0.00" step="0.01"></div>
      </div>
      <div class="ig"><label>Notes / Allerg√®nes</label><textarea id="rnotes" rows="2" placeholder="Contient : gluten, lait, oeufs..."></textarea></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
      <button class="btn btno" data-close="mr">Annuler</button>
      <button class="btn btnp" id="btn-save-r">‚úì Enregistrer</button>
    </div>
  </div>
</div>

<div class="mo" id="mv">
  <div class="md">
    <div class="mh"><h3>üí∞ Enregistrer une Vente</h3><button class="mclose" data-close="mv">‚úï</button></div>
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="fr fr2">
        <div class="ig"><label>Produit</label><select id="vprod"><option value="">S√©lectionner...</option></select></div>
        <div class="ig"><label>Quantit√©</label><input type="number" id="vqty" value="1" min="1"></div>
      </div>
      <div class="fr fr2">
        <div class="ig"><label>Prix unitaire (‚Ç¨)</label><input type="number" id="vprix" placeholder="0.00" step="0.01"></div>
        <div class="ig"><label>Date</label><input type="date" id="vdate"></div>
      </div>
      <div class="ig"><label>Canal de vente</label><select id="vcanal"><option>Boutique physique</option><option>Commande sp√©ciale</option><option>Livraison</option><option>March√©</option><option>Autre</option></select></div>
      <div style="background:var(--cream);border-radius:10px;padding:12px;font-size:13px">Total : <strong id="vtot" style="color:var(--cd);font-size:16px">‚Äî</strong></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
      <button class="btn btno" data-close="mv">Annuler</button>
      <button class="btn btnp" id="btn-save-v">‚úì Enregistrer</button>
    </div>
  </div>
</div>

<div class="mo" id="ms">
  <div class="md">
    <div class="mh"><h3>üì¶ Ingr√©dient en Stock</h3><button class="mclose" data-close="ms">‚úï</button></div>
    <input type="hidden" id="seid">
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="fr fr2">
        <div class="ig"><label>Nom *</label><input type="text" id="snom" placeholder="Ex: Farine T45"></div>
        <div class="ig"><label>Cat√©gorie</label><select id="scat"><option>Farine & F√©culents</option><option>Produits laitiers</option><option>Oeufs</option><option>Sucres</option><option>Corps gras</option><option>Fruits</option><option>Ar√¥mes & √âpices</option><option>Chocolat</option><option>Autre</option></select></div>
      </div>
      <div class="fr fr3">
        <div class="ig"><label>Stock actuel (kg/L)</label><input type="number" id="sqty" placeholder="0.0" step="0.1" min="0"></div>
        <div class="ig"><label>Seuil minimum</label><input type="number" id="sseuil" placeholder="1.0" step="0.1" min="0"></div>
        <div class="ig"><label>Prix/unit√© (‚Ç¨)</label><input type="number" id="sprix" placeholder="0.00" step="0.01" min="0"></div>
      </div>
      <div class="ig"><label>Fournisseur</label><input type="text" id="sfourn" placeholder="Nom du fournisseur"></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
      <button class="btn btno" data-close="ms">Annuler</button>
      <button class="btn btnp" id="btn-save-s">‚úì Enregistrer</button>
    </div>
  </div>
</div>

<div class="mo" id="me">
  <div class="md">
    <div class="mh"><h3>üë§ Ajouter un Employ√©</h3><button class="mclose" data-close="me">‚úï</button></div>
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="fr fr2">
        <div class="ig"><label>Pr√©nom Nom *</label><input type="text" id="enom" placeholder="Marie Dupont"></div>
        <div class="ig"><label>Poste</label><select id="eposte"><option>P√¢tissier(e)</option><option>Apprenti(e)</option><option>Vendeur(se)</option><option>Chef p√¢tissier(e)</option><option>Pr√©parateur(trice)</option></select></div>
      </div>
      <div class="fr fr2">
        <div class="ig"><label>Salaire brut mensuel (‚Ç¨)</label><input type="number" id="esal" placeholder="1800" min="0"></div>
        <div class="ig"><label>Heures / semaine</label><input type="number" id="ehw" placeholder="35" min="0" max="60"></div>
      </div>
      <div class="fr fr2">
        <div class="ig"><label>Date d'embauche</label><input type="date" id="edate"></div>
        <div class="ig"><label>Contrat</label><select id="econtrat"><option>CDI</option><option>CDD</option><option>Alternance</option><option>Int√©rim</option></select></div>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
      <button class="btn btno" data-close="me">Annuler</button>
      <button class="btn btnp" id="btn-save-e">‚úì Enregistrer</button>
    </div>
  </div>
</div>


<div class="mo" id="mrd">
  <div class="md">
    <div class="mh">
      <h3>üìñ D√©tails de la Recette</h3>
      <button class="mclose" data-close="mrd">‚úï</button>
    </div>

    <input type="hidden" id="rdid">

    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="fr fr2">
        <div class="ig"><label>Nom</label><input type="text" id="rdnom" disabled></div>
        <div class="ig"><label>Cat√©gorie</label><input type="text" id="rdcat" disabled></div>
      </div>

      <div class="fr fr2">
        <div class="ig"><label>Co√ªt mati√®res total (‚Ç¨)</label><input type="text" id="rdcout" disabled></div>
        <div class="ig"><label>Nombre de portions</label><input type="text" id="rdport" disabled></div>
      </div>

      <div class="fr fr2">
        <div class="ig"><label>Temps de production (min)</label><input type="text" id="rdtps" disabled></div>
        <div class="ig"><label>Prix de vente (‚Ç¨)</label><input type="text" id="rdpv" disabled></div>
      </div>

      <div class="ig"><label>Notes / Allerg√®nes</label><textarea id="rdnotes" rows="3" disabled></textarea></div>

      
      <div class="card" style="padding:14px;background:var(--cream);border:1px solid rgba(200,135,58,.12);box-shadow:none">
        <div class="st" style="margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid rgba(200,135,58,.18)">
          üßæ D√©tails ingr√©dients
          <span class="tag to" style="font-size:10px">mati√®res</span>
        </div>
        <div class="tw">
          <table>
            <thead>
              <tr>
                <th>Ingr√©dient</th>
                <th>Qt√©</th>
                <th>Unit√©</th>
                <th>Prix/unit√©</th>
                <th>Co√ªt</th>
              </tr>
            </thead>
            <tbody id="rdings"></tbody>
          </table>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-size:13px">
          <span style="color:var(--mocha)">Total mati√®res</span>
          <strong id="rdmat" style="color:var(--cd)">‚Äî</strong>
        </div>
      </div>
<div style="background:linear-gradient(135deg,var(--cream),var(--bl));border-radius:12px;padding:14px;border:1px solid rgba(200,135,58,.12)">
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:140px">
            <div style="font-size:10px;color:var(--mocha);text-transform:uppercase;letter-spacing:.4px">Co√ªt / portion</div>
            <div style="font-family:'Playfair Display',serif;font-size:20px;color:var(--choc)" id="rdcu">‚Äî</div>
          </div>
          <div style="flex:1;min-width:140px">
            <div style="font-size:10px;color:var(--mocha);text-transform:uppercase;letter-spacing:.4px">Marge estim√©e</div>
            <div style="font-family:'Playfair Display',serif;font-size:20px;color:var(--cd)" id="rdmg">‚Äî</div>
          </div>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:10px;margin-top:20px;justify-content:flex-end">
      <button class="btn btno" data-close="mrd">Fermer</button>
    </div>
  </div>
</div>



<div class="mo" id="msearch">
  <div class="md" style="max-width:720px">
    <div class="mh">
      <h3>üîé Recherche globale</h3>
      <button class="mclose" data-close="msearch">‚úï</button>
    </div>
    <div class="ig" style="margin-bottom:12px">
      <label>Rechercher (recettes, ventes, stock, employ√©s)</label>
      <input type="text" id="qsearch" placeholder="Ex: citron, beurre, Sophie, eclair... (Ctrl+K)">
    </div>
    <div class="card" style="padding:0;box-shadow:none;border:none;background:transparent">
      <div id="sresults" class="tw"></div>
    </div>
  </div>
</div>


<div class="mo" id="mabout">
  <div class="md" style="max-width:520px">
    <div class="mh">
      <h3>ü•ê P√¢tissPro ‚Äî D√©mo</h3>
      <button class="mclose" data-close="mabout">‚úï</button>
    </div>
    <p style="color:var(--mocha);line-height:1.7;font-size:14px">
      P√¢tissPro est une d√©mo premium (offline) pour g√©rer recettes, co√ªts, ventes, stocks et √©quipe.
      <br><br>
      <strong>Astuce :</strong> sur mobile, ajoute-la √† l‚Äô√©cran d‚Äôaccueil pour un rendu ‚Äúapp‚Äù.
    </p>
    <div style="margin-top:16px;background:linear-gradient(135deg,var(--cream),var(--bl));border-radius:12px;padding:14px;border:1px solid rgba(200,135,58,.12)">
      <div style="font-size:12px;color:var(--mocha)">Version</div>
      <div style="font-family:'Playfair Display',serif;font-size:22px;color:var(--cd);font-style:italic">v1.0 (D√©mo)</div>
    </div>
    <div style="display:flex;gap:10px;margin-top:18px;justify-content:flex-end">
      <button class="btn btno" data-close="mabout">Fermer</button>
    </div>
  </div>
</div>


<div class="notif" id="notif"><span id="ni">‚úì</span><span id="nm">Action r√©ussie</span></div>

<script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<script>
// ============ STATE ============
const S = { user:null, plan:'free', recettes:[], ventes:[], stocks:[], employes:[], heures:[] };
let caChart=null, vChart=null;

// ============ UTILS ============

const fnum = (n, d=2) => {
  const x = Number(n||0);
  return x.toLocaleString('fr-FR',{minimumFractionDigits:d, maximumFractionDigits:d});
};

const fmt = n => new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:2}).format(n||0);
const fd = s => s ? new Date(s).toLocaleDateString('fr-FR',{day:'2-digit',month:'short',year:'numeric'}) : '';
const g = id => document.getElementById(id);
const ntf = (msg, type='') => {
  const n=g('notif'); n.className='notif show'+(type?' n'+type:'');
  g('ni').textContent = type==='s'?'‚úì':type==='e'?'‚úï':'‚Ñπ';
  g('nm').textContent = msg;
  setTimeout(()=>n.classList.remove('show'), 3500);
};
// --- PERSISTENCE ---
const STORAGE_KEY = 'patisspro_state_v1';
let _saveT = null;
function saveState() {
  clearTimeout(_saveT);
  _saveT = setTimeout(() => {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({ S, theme: document.body.dataset.theme || 'light' }));
    } catch(e) { /* ignore */ }
  }, 250);
}
function loadStateOrDemo() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) { loadDemo(); return; }
    const st = JSON.parse(raw);
    if(st?.S) {
      // hydrate state (keep same object refs)
      Object.assign(S, { plan: st.S.plan || 'free', user: st.S.user || null });
      S.recettes = Array.isArray(st.S.recettes) ? st.S.recettes : [];
      S.ventes   = Array.isArray(st.S.ventes)   ? st.S.ventes   : [];
      S.stocks   = Array.isArray(st.S.stocks)   ? st.S.stocks   : [];
      S.employes = Array.isArray(st.S.employes) ? st.S.employes : [];
      S.heures   = Array.isArray(st.S.heures)   ? st.S.heures   : [];
      // restore theme
      if(st.theme) setTheme(st.theme);
      return;
    }
  } catch(e) {}
  loadStateOrDemo();
}

// --- THEME ---
function setTheme(t){
  const theme = (t === 'dark') ? 'dark' : 'light';
  document.body.dataset.theme = theme;
  try { localStorage.setItem('patisspro_theme', theme); } catch(e) {}
  const b = document.getElementById('themeToggle');
  if(b) b.textContent = theme === 'dark' ? '‚òÄÔ∏è Mode clair' : 'üåô ';
}
function toggleTheme(){
  const cur = document.body.dataset.theme || 'light';
  setTheme(cur === 'dark' ? 'light' : 'dark');
  saveState();
}
function initTheme(){
  try {
    const saved = localStorage.getItem('patisspro_theme');
    if(saved) { setTheme(saved); return; }
  } catch(e) {}
  // Prefer system
  const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  setTheme(prefersDark ? 'dark' : 'light');
}

const openM = id => g(id).classList.add('open');
const closeM = id => g(id).classList.remove('open');


function populatePrixRecettes(){
  const sel = g('prrec');
  if(!sel) return;
  const cur = sel.value;
  sel.innerHTML = '<option value="">‚Äî Choisir une recette ‚Äî</option>';

  (S.recettes||[]).forEach(r => {
    // co√ªt unitaire = co√ªt total / portions (si portions>1), sinon co√ªt total
    const portions = Number(r.portions || 1);
    const unitCost = (Number(r.cout||0) / (portions||1));
    const opt = document.createElement('option');
    opt.value = r.id;
    opt.dataset.cout = unitCost.toFixed(4);
    opt.dataset.nom = r.nom || '';
    opt.textContent = `${r.nom || 'Recette'}  ‚Äî  co√ªt/portion: ${fmt(unitCost)}`;
    sel.appendChild(opt);
  });

  // restore selection if possible
  if(cur) sel.value = cur;
}

function bindPrixRecetteSelect(){
  const sel = g('prrec');
  if(!sel || sel.dataset.bound==='1') return;
  sel.dataset.bound='1';

  sel.addEventListener('change', () => {
    const opt = sel.selectedOptions?.[0];
    if(!opt || !opt.dataset.cout) return;
    const c = Number(opt.dataset.cout||0);
    g('pcout').value = (Math.round(c*100)/100).toFixed(2);
    calcPrix();
  });
}



function renderSearchResults(){
  const q = (g('qsearch')?.value || '').trim().toLowerCase();
  const wrap = g('sresults');
  if(!wrap) return;
  if(!q){
    wrap.innerHTML = '<div style="color:var(--mocha);font-size:13px;padding:10px">Tape un mot-cl√©‚Ä¶</div>';
    return;
  }
  const res = [];
  const push = (type, title, meta, action) => res.push({type,title,meta,action});

  (S.recettes||[]).forEach(r => {
    if((r.nom||'').toLowerCase().includes(q) || (r.notes||'').toLowerCase().includes(q)){
      push('recette', r.nom, `${r.cat||'Recette'} ‚Ä¢ PV ${fmt(r.pv||0)} ‚Ä¢ Co√ªt ${fmt(r.cout||0)}`, () => { showPage('recettes'); openRecetteDetail(r.id); });
    }
    (r.ings||[]).forEach(it => {
      if((it.nom||'').toLowerCase().includes(q)){
        push('recette', r.nom, `Ingr√©dient: ${it.nom} ‚Ä¢ ${it.qty||0} ${it.unit||''}`, () => { showPage('recettes'); openRecetteDetail(r.id); });
      }
    });
  });

  (S.stocks||[]).forEach(s => {
    if((s.nom||'').toLowerCase().includes(q) || (s.cat||'').toLowerCase().includes(q) || (s.fourn||'').toLowerCase().includes(q)){
      push('stock', s.nom, `${s.cat||''} ‚Ä¢ Stock ${s.qty||0} ‚Ä¢ Seuil ${s.seuil||0}`, () => { showPage('stocks'); });
    }
  });

  (S.employes||[]).forEach(e => {
    if((e.nom||'').toLowerCase().includes(q) || (e.poste||'').toLowerCase().includes(q)){
      push('employ√©', e.nom, `${e.poste||''} ‚Ä¢ ${e.contrat||''}`, () => { showPage('employes'); });
    }
  });

  (S.ventes||[]).slice(0,200).forEach(v => {
    if((v.produit||'').toLowerCase().includes(q) || (v.canal||'').toLowerCase().includes(q)){
      push('vente', v.produit, `${fd(v.date)} ‚Ä¢ Qt√© ${v.qty} ‚Ä¢ Total ${fmt(v.total||0)}`, () => { showPage('ventes'); });
    }
  });

  if(!res.length){
    wrap.innerHTML = '<div style="color:var(--mocha);font-size:13px;padding:10px">Aucun r√©sultat.</div>';
    return;
  }

  wrap.innerHTML = res.slice(0,30).map((r,i)=>`
    <div class="srow" data-sel="${i}">
      <span class="sbadge">${r.type}</span>
      <div style="flex:1">
        <div class="stitle">${r.title}</div>
        <div class="smeta">${r.meta}</div>
      </div>
      <div style="color:var(--mocha)">‚Ü©Ô∏é</div>
    </div>
  `).join('');

  wrap.querySelectorAll('[data-sel]').forEach(el => {
    el.addEventListener('click', () => {
      const idx = Number(el.dataset.sel);
      closeM('msearch');
      setTimeout(()=>res[idx].action(), 50);
    });
  });
}


// ============ EVENTS SETUP ============
document.addEventListener('DOMContentLoaded', () => {

  // Mobile sidebar toggle
  const sb = document.querySelector('.sidebar');
  const ov = document.getElementById('sbover');
  const openSB = () => { sb?.classList.add('open'); ov?.classList.add('show'); };
  const closeSB = () => { sb?.classList.remove('open'); ov?.classList.remove('show'); };
  document.getElementById('btn-menu')?.addEventListener('click', openSB);
  ov?.addEventListener('click', closeSB);

  // Close sidebar when clicking a nav item on mobile
  document.querySelectorAll('.ni,[data-page]').forEach(el => {
    el.addEventListener('click', () => { if(window.innerWidth<=768) closeSB(); });
  });

  // Mobile search button
  document.getElementById('btn-msearch')?.addEventListener('click', () => {
    openM('msearch');
    setTimeout(()=>g('qsearch')?.focus(), 50);
  });

  document.getElementById('btn-about')?.addEventListener('click', () => openM('mabout'));

  // Global search
  window.addEventListener('keydown', (e) => {
    const isK = (e.key || '').toLowerCase() === 'k';
    if((e.ctrlKey || e.metaKey) && isK){
      e.preventDefault();
      openM('msearch');
      setTimeout(()=>g('qsearch')?.focus(), 50);
    }
  });
  g('btn-search')?.addEventListener('click', () => { openM('msearch'); setTimeout(()=>g('qsearch')?.focus(), 50); });
  g('qsearch')?.addEventListener('input', renderSearchResults);

  document.getElementById('btn-logout')?.addEventListener('click', logout);
  initTheme();
  document.getElementById('themeToggle')?.addEventListener('click', toggleTheme);

  // Auth
  g('btn-login').addEventListener('click', doLogin);
  g('btn-register').addEventListener('click', doRegister);
  g('btn-demo').addEventListener('click', doDemo);

  // Nav items
  document.querySelectorAll('.ni').forEach(el => {
    el.addEventListener('click', () => showPage(el.dataset.page, el));
  });

  // Buttons that open modals via data-modal
  document.querySelectorAll('[data-modal]').forEach(el => {
    el.addEventListener('click', () => openM(el.dataset.modal));
  });

  // Close buttons
  document.querySelectorAll('[data-close]').forEach(el => {
    el.addEventListener('click', () => closeM(el.dataset.close));
  });

  // Modal overlay click
  document.querySelectorAll('.mo').forEach(o => {
    o.addEventListener('click', e => { if(e.target===o) o.classList.remove('open'); });
  });

  // Prix calculators
  g('pmarge').addEventListener('input', () => { g('margev').textContent=g('pmarge').value+'%'; calcPrix(); });
  g('pcout').addEventListener('input', calcPrix);
  g('ptva').addEventListener('change', calcPrix);
  g('srfix').addEventListener('input', calcSeuil);
  g('srvar').addEventListener('input', calcSeuil);
  g('srpv').addEventListener('input', calcSeuil);

  // Recette calc
  ['npieces','ttravail','couth'].forEach(id => g(id).addEventListener('input', calcRecette));
  g('btn-add-ing').addEventListener('click', addIng);

  // Vente total preview
  g('vqty').addEventListener('input', updVTot);
  g('vprix').addEventListener('input', updVTot);
  g('vprod').addEventListener('change', () => {
    const o = g('vprod').selectedOptions[0];
    if(o?.dataset.prix){ g('vprix').value=o.dataset.prix; updVTot(); }
  });

  // Save buttons
  g('btn-save-r').addEventListener('click', saveR);
  g('btn-save-v').addEventListener('click', saveV);
  g('btn-save-s').addEventListener('click', saveS);
  g('btn-save-e').addEventListener('click', saveE);
  g('btn-saisir-h').addEventListener('click', saisirH);
  g('btn-pro').addEventListener('click', upgradeToPro);

  // Upgrade CTA
  g('supg').querySelector('.btnupg').addEventListener('click', () => showPage('abonnement', null));

  // Stock add button
  g('btn-add-stock').addEventListener('click', () => { g('seid').value=''; clearStockForm(); openM('ms'); });
  g('btn-new-recette').addEventListener('click', openNewRecette);
});


function logout(){
  S.user = null;
  S.plan = 'free';
  S.recettes = [];
  S.ventes = [];
  S.stocks = [];
  S.employes = [];
  S.heures = [];

  localStorage.clear();

  document.getElementById('app').style.display = 'none';
  document.getElementById('auth').style.display = 'flex';

  const le = document.getElementById('lemail');
  const lp = document.getElementById('lpwd');
  if(le) le.value = '';
  if(lp) lp.value = '';

  ntf("D√©connect√© avec succ√®s","s");
}


// ============ AUTH ============
function switchTab(t) {
  document.querySelectorAll('.atab').forEach((b,i)=>b.classList.toggle('active',(t==='login'&&i===0)||(t==='register'&&i===1)));
  g('lform').style.display = t==='login'?'block':'none';
  g('rform').style.display = t==='register'?'block':'none';
}
// ====== AUTH SECURIS√âE (offline) ======
// Note : en mode 100% offline, la "s√©curit√©" = ne jamais stocker le mot de passe en clair.
// Ici on stocke uniquement un hash PBKDF2 (avec salt) dans localStorage.
// Pour une s√©curit√© "pro" (anti-vol / anti-triche), il faut un serveur + HTTPS + Argon2/bcrypt.

const USERS_KEY = 'pp_users_v1';

const b64 = {
  enc: (buf) => btoa(String.fromCharCode(...new Uint8Array(buf))),
  dec: (b64s) => Uint8Array.from(atob(b64s), c => c.charCodeAt(0)).buffer
};

function sha256_fallback(ascii) {
  // Minimal SHA-256 (fallback quand crypto.subtle n'est pas dispo, ex: certains contextes file://)
  const rightRotate = (v, amt) => (v >>> amt) | (v << (32 - amt));
  const maxWord = Math.pow(2, 32);
  let result = '';

  const words = [];
  const asciiBitLength = ascii.length * 8;

  let hash = sha256_fallback.h = sha256_fallback.h || [];
  let k = sha256_fallback.k = sha256_fallback.k || [];
  let primeCounter = k.length;

  const isComposite = {};
  for (let candidate = 2; primeCounter < 64; candidate++) {
    if (!isComposite[candidate]) {
      for (let i = 0; i < 313; i += candidate) isComposite[i] = candidate;
      hash[primeCounter] = (Math.pow(candidate, .5) * maxWord) | 0;
      k[primeCounter++] = (Math.pow(candidate, 1/3) * maxWord) | 0;
    }
  }

  ascii += '¬Ä';
  while (ascii.length % 64 - 56) ascii += ' ';
  for (let i = 0; i < ascii.length; i++) {
    const j = ascii.charCodeAt(i);
    words[i >> 2] |= j << ((3 - i) % 4) * 8;
  }
  words[words.length] = (asciiBitLength / maxWord) | 0;
  words[words.length] = asciiBitLength;

  for (let j = 0; j < words.length;) {
    const w = words.slice(j, j += 16);
    const oldHash = hash.slice(0);

    for (let i = 0; i < 64; i++) {
      const w15 = w[i - 15], w2 = w[i - 2];

      const a = hash[0], e = hash[4];
      const temp1 = (hash[7]
        + (rightRotate(e, 6) ^ rightRotate(e, 11) ^ rightRotate(e, 25))
        + ((e & hash[5]) ^ ((~e) & hash[6]))
        + k[i]
        + (w[i] = (i < 16) ? w[i] : (
            w[i - 16]
            + (rightRotate(w15, 7) ^ rightRotate(w15, 18) ^ (w15 >>> 3))
            + w[i - 7]
            + (rightRotate(w2, 17) ^ rightRotate(w2, 19) ^ (w2 >>> 10))
          ) | 0)
      ) | 0;

      const temp2 = ((rightRotate(a, 2) ^ rightRotate(a, 13) ^ rightRotate(a, 22))
        + ((a & hash[1]) ^ (a & hash[2]) ^ (hash[1] & hash[2]))
      ) | 0;

      hash = [(temp1 + temp2) | 0].concat(hash);
      hash[4] = (hash[4] + temp1) | 0;
      hash.pop();
    }

    for (let i = 0; i < 8; i++) hash[i] = (hash[i] + oldHash[i]) | 0;
  }

  for (let i = 0; i < 8; i++) {
    for (let j = 3; j + 1; j--) {
      const b = (hash[i] >> (j * 8)) & 255;
      result += ((b < 16) ? 0 : '') + b.toString(16);
    }
  }
  return result;
}

async function pbkdf2Hash(pwd, saltB64, iterations=150000) {
  // Chemin "fort" si disponible
  if (window.crypto && crypto.subtle && window.isSecureContext) {
    const enc = new TextEncoder();
    const keyMaterial = await crypto.subtle.importKey(
      'raw',
      enc.encode(pwd),
      { name: 'PBKDF2' },
      false,
      ['deriveBits']
    );
    const saltBuf = b64.dec(saltB64);
    const bits = await crypto.subtle.deriveBits(
      { name:'PBKDF2', hash:'SHA-256', salt: saltBuf, iterations },
      keyMaterial,
      256
    );
    return b64.enc(bits);
  }

  // Fallback offline: hash r√©p√©t√© (moins robuste qu'un vrai PBKDF2, mais √©vite le stockage en clair)
  let x = saltB64 + '|' + pwd;
  for(let i=0;i<5000;i++) x = sha256_fallback(x);
  return x;
}


function genSaltB64(len=16){
  const a = new Uint8Array(len);
  crypto.getRandomValues(a);
  return btoa(String.fromCharCode(...a));
}

function loadUsers(){
  try { return JSON.parse(localStorage.getItem(USERS_KEY) || '[]'); }
  catch { return []; }
}
function saveUsers(users){
  localStorage.setItem(USERS_KEY, JSON.stringify(users));
}

async function doLogin() {
  const e = g('lemail').value.trim().toLowerCase();
  const p = g('lpwd').value;
  if(!e){ ntf('Email requis','e'); return; }
  if(!p){ ntf('Mot de passe requis','e'); return; }

  const users = loadUsers();
  const u = users.find(x => (x.email||'').toLowerCase() === e);

  // Autorise toujours la d√©mo, m√™me sans compte enregistr√©
  if(!u && e === 'demo@patisserie.fr' && p === 'demo1234'){
    S.user = {name:'Marie', shop:'La Maison Sucr√©e', email:e};
    g('lpwd').value = '';
    launch();
    return;
  }

  if(!u){ ntf('Compte introuvable','e'); return; }

  try{
    const h = await pbkdf2Hash(p, u.salt);
    if(h !== u.hash){ ntf('Mot de passe incorrect','e'); return; }
    S.user = {name:u.name, shop:u.shop, email:u.email};
    g('lpwd').value = '';
    launch();
  }catch(err){
    console.error(err);
    ntf("Impossible de v√©rifier le mot de passe (navigateur)",'e');
  }
}

async function doRegister() {
  const sh = g('rshop').value.trim();
  const n  = g('rname').value.trim();
  const e  = g('remail').value.trim().toLowerCase();
  const p  = g('rpwd').value;

  if(!sh||!n||!e||!p){ ntf('Tous les champs sont requis','e'); return; }
  if(p.length < 8){ ntf('Mot de passe : minimum 8 caract√®res','e'); return; }

  const users = loadUsers();
  if(users.some(x => (x.email||'').toLowerCase() === e)){
    ntf('Un compte existe d√©j√† avec cet email','e'); return;
  }

  try{
    const salt = genSaltB64(16);
    const hash = await pbkdf2Hash(p, salt);
    users.push({ email:e, name:n, shop:sh, salt, hash, createdAt: Date.now() });
    saveUsers(users);

    // Auto-login apr√®s inscription
    S.user = {name:n, shop:sh, email:e};
    g('rpwd').value = '';
    launch();
  }catch(err){
    console.error(err);
    ntf("Impossible de cr√©er le compte (navigateur)",'e');
  }
}

function doDemo() {
  // D√©mo rapide (offline)
  S.user = {name:'Marie', shop:'La Maison Sucr√©e', email:'demo@patisserie.fr'};
  launch();
}


function launch() {
  const sp = document.getElementById('splash');
  if(sp){ sp.style.display='flex'; }

  loadDemo();
  g('auth').style.display = 'none';
  g('app').style.display = 'block';
  g('uname').textContent = "L'√©toile de sucre";
  g('uav').textContent = (S.user.name||'P')[0].toUpperCase();
  g('gname').textContent = 'Michel';
  g('vdate').valueAsDate = new Date();
  g('sdate').valueAsDate = new Date();
  refreshAll();
  saveState();
  setTimeout(initCharts, 200);
  setTimeout(()=>{ const sp=document.getElementById('splash'); if(sp){ sp.style.display='none'; } }, 420);
}

// ============ DEMO DATA ============
function loadDemo() {
  S.recettes = [
    {id:1, nom:'Tarte Citron Meringu√©e', cat:'Tartes', cout:3.20, portions:8, tps:90, pv:4.50, notes:'Gluten, oeufs, lait',
      ings:[{nom:'Farine T45',qty:0.35,unit:'kg',pu:0.90},{nom:'Beurre AOP',qty:0.18,unit:'kg',pu:8.50},{nom:'Sucre fin',qty:0.22,unit:'kg',pu:1.10},{nom:'Oeufs frais',qty:4,unit:'u',pu:0.35},{nom:'Citrons',qty:0.35,unit:'kg',pu:2.20},{nom:'Cr√®me 35%',qty:0.12,unit:'L',pu:3.80}]
    },
    {id:2, nom:'Croissant au Beurre', cat:'Viennoiseries', cout:0.45, portions:1, tps:5, pv:1.20, notes:'Gluten, lait',
      ings:[{nom:'Farine T45',qty:0.09,unit:'kg',pu:0.90},{nom:'Beurre AOP',qty:0.035,unit:'kg',pu:8.50},{nom:'Sucre fin',qty:0.008,unit:'kg',pu:1.10},{nom:'Levure',qty:0.003,unit:'kg',pu:6.00}]
    },
    {id:3, nom:'Eclair au Chocolat', cat:'Petits fours', cout:0.80, portions:1, tps:8, pv:2.80, notes:'Gluten, oeufs, lait',
      ings:[{nom:'Farine T45',qty:0.06,unit:'kg',pu:0.90},{nom:'Beurre AOP',qty:0.03,unit:'kg',pu:8.50},{nom:'Oeufs frais',qty:1,unit:'u',pu:0.35},{nom:'Chocolat noir 70%',qty:0.025,unit:'kg',pu:14.00},{nom:'Cr√®me 35%',qty:0.06,unit:'L',pu:3.80}]
    },
    {id:4, nom:'Entremet Framboise', cat:'Entremets', cout:7.50, portions:10, tps:180, pv:6.50, notes:'Gluten, lait, oeufs',
      ings:[{nom:'Cr√®me 35%',qty:0.35,unit:'L',pu:3.80},{nom:'Framboises',qty:0.45,unit:'kg',pu:9.50},{nom:'Sucre fin',qty:0.18,unit:'kg',pu:1.10},{nom:'G√©latine',qty:0.01,unit:'kg',pu:55.00},{nom:'Beurre AOP',qty:0.10,unit:'kg',pu:8.50}]
    },
    {id:5, nom:'Madeleine Maison', cat:'Cakes', cout:0.20, portions:1, tps:3, pv:0.90, notes:'Gluten, oeufs, lait',
      ings:[{nom:'Farine T45',qty:0.03,unit:'kg',pu:0.90},{nom:'Beurre AOP',qty:0.02,unit:'kg',pu:8.50},{nom:'Sucre fin',qty:0.02,unit:'kg',pu:1.10},{nom:'Oeufs frais',qty:1,unit:'u',pu:0.35}]
    },
  ];
  const today = new Date();
  const ps = ['Tarte Citron Meringu√©e','Croissant au Beurre','Eclair au Chocolat','Entremet Framboise','Madeleine Maison'];
  const px = [4.50,1.20,2.80,6.50,0.90];
  S.ventes = [];
  for(let i=0;i<45;i++) {
    const d=new Date(today); d.setDate(d.getDate()-i);
    const ri=Math.floor(Math.random()*ps.length), qty=Math.floor(Math.random()*8)+1;
    S.ventes.push({id:i+1, produit:ps[ri], qty, prix:px[ri], date:d.toISOString().split('T')[0], total:+(qty*px[ri]).toFixed(2), canal:'Boutique physique'});
  }
  S.stocks = [
    {id:1, nom:'Farine T45', cat:'Farine & F√©culents', qty:8.5, seuil:5, prix:0.90, fourn:'Moulin Dupont'},
    {id:2, nom:'Beurre AOP', cat:'Corps gras', qty:2.1, seuil:3, prix:8.50, fourn:'Laiterie Normandie'},
    {id:3, nom:'Oeufs frais', cat:'Oeufs', qty:5.4, seuil:2, prix:5.20, fourn:'Ferme du Moulin'},
    {id:4, nom:'Sucre fin', cat:'Sucres', qty:12.0, seuil:4, prix:1.10, fourn:'Cristal Union'},
    {id:5, nom:'Cr√®me 35%', cat:'Produits laitiers', qty:1.2, seuil:2, prix:3.80, fourn:'Lactalis'},
    {id:6, nom:'Chocolat noir 70%', cat:'Chocolat', qty:0.8, seuil:1, prix:14.00, fourn:'Valrhona'},
    {id:7, nom:'Citrons', cat:'Fruits', qty:3.5, seuil:1, prix:2.20, fourn:'March√© Rungis'},
    {id:8, nom:'Vanille gousses', cat:'Ar√¥mes & √âpices', qty:0.05, seuil:0.1, prix:400, fourn:'√âpices du Monde'},
  ];
  S.employes = [
    {id:1, nom:'Sophie Martin', poste:'Chef P√¢tissi√®re', sal:2600, h:39, date:'2019-03-01', contrat:'CDI'},
    {id:2, nom:'Lucas Bernard', poste:'P√¢tissier(e)', sal:1900, h:35, date:'2021-06-15', contrat:'CDI'},
    {id:3, nom:'Emma Petit', poste:'Apprenti(e)', sal:900, h:35, date:'2023-09-01', contrat:'Alternance'},
    {id:4, nom:'Thomas Roux', poste:'Vendeur(se)', sal:1650, h:35, date:'2022-01-10', contrat:'CDD'},
  ];
  addIng(); addIng(); addIng();
}

// ============ NAVIGATION ============
function showPage(page, el) {
  if((page==='rapports'||page==='previsions') && S.plan==='free') {
    _ap(page, el);
    showGate(page);
    return;
  }
  _ap(page, el);
  if(page==='dashboard') refreshDB();
  if(page==='recettes') renderRecettes();
  if(page==='prix'){ renderPrix(); populatePrixRecettes(); bindPrixRecetteSelect(); }
  if(page==='ventes') renderVentes();
  if(page==='stocks') renderStocks();
  if(page==='employes') renderEmployes();
  if(page==='rapports') renderRap();
  if(page==='previsions') renderPrev();
}
function _ap(page, el) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  g('page-'+page).classList.add('active');
  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('active'));
  (el || document.querySelector(`[data-page="${page}"]`))?.classList.add('active');
}

// ============ PREMIUM ============
function showGate(page) {
  const cfg = {
    rapports: { icon:'üìà', title:'Rapports Avanc√©s', desc:'Analyses d√©taill√©es, export PDF optimis√©.' },
    previsions: { icon:'üîÆ', title:'Pr√©visions IA', desc:'Anticipez vos ventes et optimisez votre production.' }
  };
  const c = cfg[page];
  const cid = page==='rapports' ? 'rapc' : 'prevc';
  const el = g(cid);
  el.innerHTML = '';
  const card = document.createElement('div');
  card.className = 'card';
  card.style.cssText = 'text-align:center;padding:44px 28px';
  card.innerHTML = `
    <div style="font-size:50px;margin-bottom:16px">${c.icon} üîí</div>
    <h3 style="font-family:'Playfair Display',serif;font-size:22px;font-style:italic;margin-bottom:10px">Fonctionnalit√© Premium</h3>
    <p style="color:var(--mocha);margin-bottom:24px;line-height:1.6;font-size:14px;max-width:500px;margin-left:auto;margin-right:auto">${c.desc}</p>
    <div class="pcg" style="max-width:540px;margin:0 auto">
      <div class="pc"><div class="pcp" style="font-size:26px">0 ‚Ç¨ <span>/mois</span></div><p style="font-size:12px;color:var(--mocha);margin-top:10px">Non disponible en plan gratuit.</p></div>
      <div class="pc feat"><div class="pcp" style="font-size:26px">30 ‚Ç¨ <span>/mois</span></div><p style="font-size:12px;color:var(--chocm);margin:10px 0 14px">D√©bloquez ${c.title} et toutes les fonctionnalit√©s Pro.</p><button class="btn btnp" style="width:100%" id="gate-upgrade-btn">Passer √† Pro</button></div>
    </div>`;
  el.appendChild(card);
  g('gate-upgrade-btn').addEventListener('click', upgradeToPro);
}

function upgradeToPro() {
  S.plan = 'pro';
  g('uplan').textContent = '‚ú® Plan Pro';
  g('supg').style.display = 'none';
  g('lock-r').style.display = 'none';
  g('lock-p').style.display = 'none';
  g('planname').textContent = 'Pro ‚ú®';
  g('plandesc').textContent = 'Toutes les fonctionnalit√©s d√©bloqu√©es. Merci !';
  renderRap();
  renderPrev();
  ntf('üéâ Bienvenue sur Plan Pro ! Tout est d√©bloqu√©.', 's');
  saveState();
}


// ============ EXPORTS ============
function exportPDF() {
  if(!window.jspdf || !window.jspdf.jsPDF){
    ntf("Export PDF indisponible hors-ligne (lib jsPDF).","e");
    return;
  }
  if (S.plan !== 'pro') { ntf('Fonction r√©serv√©e au Plan Pro','e'); return; }
  if (!window.jspdf?.jsPDF) { ntf('Librairie PDF indisponible','e'); return; }
  const { jsPDF } = window.jspdf;

  // A4 portrait, mm
  const doc = new jsPDF({ unit:'mm', format:'a4', compress:true });
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const margin = 14;

  const rgb = {
    caramel: [200,135,58],
    cd: [139,94,26],
    choc: [61,31,10],
    mocha: [140,94,60],
    cream: [250,244,232],
    warm: [254,249,240],
    success: [46,125,50],
    danger: [192,57,43]
  };

  const shop = (S.user?.shop || 'P√¢tissPro').toString();
  const user = (S.user?.name || '').toString();
  const now = new Date();
  const dateStr = now.toLocaleDateString('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

  // Helpers
  const setRGB = (fn, arr) => fn.call(doc, arr[0], arr[1], arr[2]);
  const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

  const parseEuro = (s) => {
    if (!s) return null;
    const num = (''+s).replace(/[^\d,.-]/g,'').replace(',', '.');
    const v = parseFloat(num);
    return Number.isFinite(v) ? v : null;
  };

  const fmtE = (v) => new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}).format(v||0);
  const fmtE2 = (v) => new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:2}).format(v||0);

  const safeText = (t)=> (t==null ? '' : (''+t));

  const headerH = 30;

  // Header band
  setRGB(doc.setFillColor, rgb.caramel);
  doc.rect(0, 0, pageW, headerH, 'F');

  // Brand
  doc.setFont('helvetica','bold');
  doc.setFontSize(18);
  doc.setTextColor(255,255,255);
  doc.text('P√¢tissPro', margin, 18);
  doc.setFont('helvetica','normal');
  doc.setFontSize(10);
  doc.setTextColor(255,255,255);
  doc.text('Rapport premium ‚Äî export PDF optimis√©', margin, 24);

  // Right side meta
  doc.setFontSize(9);
  doc.text(`Boutique : ${safeText(shop)}`, pageW - margin, 14, { align:'right' });
  doc.text(`Date : ${safeText(dateStr)}`, pageW - margin, 20, { align:'right' });
  if(user) doc.text(`Michel : ${safeText(user)}`, pageW - margin, 26, { align:'right' });

  // Body bg (subtle)
  setRGB(doc.setFillColor, rgb.warm);
  doc.rect(0, headerH, pageW, pageH - headerH, 'F');

  // KPI values
  const caEl = g('kca')?.textContent || '';
  const coutEl = g('kcout')?.textContent || '';
  const margeEl = g('kmarge')?.textContent || '';
  const caVal = parseEuro(caEl);
  const coutVal = parseEuro(coutEl);

  // if dashboard not visited, compute month CA
  const ms = new Date().toISOString().slice(0,7);
  const caMonth = caVal != null ? caVal : S.ventes.filter(v=>v.date?.startsWith(ms)).reduce((s,v)=>s+(+v.total||0),0);
  const coutMat = coutVal != null ? coutVal : caMonth*0.32;

  const margePct = (() => {
    const m = parseFloat((''+margeEl).replace(/[^\d.]/g,''));
    if (Number.isFinite(m)) return clamp(m, 0, 100);
    // derive from recipes if possible
    return 60;
  })();

  // KPI cards
  const kY = headerH + 10;
  const gap = 6;
  const cardW = (pageW - margin*2 - gap*2) / 3;
  const cardH = 22;

  const kpiCard = (x, y, title, value, hint, tone='caramel') => {
    // shadow-ish border
    doc.setDrawColor(230, 215, 200);
    doc.setLineWidth(0.4);
    doc.roundedRect(x, y, cardW, cardH, 3, 3, 'S');

    // top accent
    const accent = tone==='danger' ? rgb.danger : tone==='success' ? rgb.success : rgb.caramel;
    setRGB(doc.setFillColor, accent);
    doc.roundedRect(x, y, cardW, 3.2, 3, 3, 'F');

    doc.setFont('helvetica','normal');
    doc.setTextColor(rgb.mocha[0],rgb.mocha[1],rgb.mocha[2]);
    doc.setFontSize(8.5);
    doc.text(title, x+4, y+8);

    doc.setFont('helvetica','bold');
    doc.setTextColor(rgb.choc[0],rgb.choc[1],rgb.choc[2]);
    doc.setFontSize(14);
    doc.text(value, x+4, y+16);

    doc.setFont('helvetica','normal');
    doc.setTextColor(120,120,120);
    doc.setFontSize(8);
    doc.text(hint, x+4, y+20);
  };

  kpiCard(margin, kY, 'Chiffre d‚Äôaffaires (mois)', fmtE(caMonth), 'P√©riode : mois en cours', 'success');
  kpiCard(margin + cardW + gap, kY, 'Marge brute', `${Math.round(margePct)}%`, 'Objectif conseill√© : 55‚Äì65%', 'caramel');
  kpiCard(margin + (cardW + gap)*2, kY, 'Co√ªt mati√®res', fmtE(coutMat), 'Sur base CA & saisies', coutMat > caMonth*0.4 ? 'danger' : 'caramel');

  // Compute top products
  const prodMap = {};
  S.ventes.forEach(v => {
    const n = v.produit || '‚Äî';
    prodMap[n] = (prodMap[n]||0) + (+v.total||0);
  });
  const top = Object.entries(prodMap).sort((a,b)=>b[1]-a[1]).slice(0,5);

  // Stock alerts
  const alerts = S.stocks.filter(s => (+s.qty||0) <= (+s.seuil||0)).slice(0,6);

  let y = kY + cardH + 12;

  const sectionTitle = (t, y) => {
    doc.setFont('helvetica','bold');
    doc.setFontSize(11);
    doc.setTextColor(rgb.choc[0],rgb.choc[1],rgb.choc[2]);
    doc.text(t, margin, y);
    doc.setDrawColor(235, 220, 205);
    doc.setLineWidth(0.4);
    doc.line(margin, y+2, pageW - margin, y+2);
  };

  // Top products table
  sectionTitle('üèÜ Top produits (CA)', y);
  y += 8;

  const tableX = margin;
  const tableW = pageW - margin*2;
  const rowH = 7;
  const col1 = tableX;
  const col2 = tableX + tableW*0.62;
  const col3 = tableX + tableW*0.80;

  // header row bg
  doc.setFillColor(250,244,232);
  doc.rect(tableX, y, tableW, rowH, 'F');
  doc.setFontSize(8.5);
  doc.setTextColor(rgb.mocha[0],rgb.mocha[1],rgb.mocha[2]);
  doc.setFont('helvetica','bold');
  doc.text('Produit', col1+2, y+4.8);
  doc.text('CA', col2+2, y+4.8);
  doc.text('Part', col3+2, y+4.8);

  const caTotal = Object.values(prodMap).reduce((s,v)=>s+v,0) || 1;

  y += rowH;

  doc.setFont('helvetica','normal');
  doc.setFontSize(9);
  top.forEach(([name, val], idx) => {
    if(y + rowH > pageH - 30){ doc.addPage(); y = margin; }
    // zebra
    if(idx%2===0){ doc.setFillColor(255,255,255); doc.rect(tableX, y, tableW, rowH, 'F'); }
    doc.setTextColor(rgb.choc[0],rgb.choc[1],rgb.choc[2]);
    doc.text(safeText(name).slice(0,34), col1+2, y+4.8);
    doc.setFont('helvetica','bold');
    doc.text(fmtE2(val), col2+2, y+4.8);
    doc.setFont('helvetica','normal');

    const pct = Math.round((val/caTotal)*100);
    doc.setTextColor(rgb.mocha[0],rgb.mocha[1],rgb.mocha[2]);
    doc.text(`${pct}%`, col3+2, y+4.8);

    // progress bar
    const barX = col3 + 16;
    const barW = tableX + tableW - barX - 2;
    doc.setDrawColor(235, 220, 205);
    doc.setFillColor(253,232,208);
    doc.roundedRect(barX, y+2.2, barW, 2.6, 1.3, 1.3, 'F');
    setRGB(doc.setFillColor, rgb.caramel);
    doc.roundedRect(barX, y+2.2, barW*(pct/100), 2.6, 1.3, 1.3, 'F');

    y += rowH;
  });

  if(top.length===0){
    doc.setTextColor(rgb.mocha[0],rgb.mocha[1],rgb.mocha[2]);
    doc.text("Aucune vente enregistr√©e pour l'instant.", tableX+2, y+5);
    y += 10;
  }

  y += 6;

  // Stock alerts
  sectionTitle('‚ö†Ô∏è Alertes stock', y);
  y += 8;

  if(alerts.length===0){
    doc.setTextColor(rgb.success[0],rgb.success[1],rgb.success[2]);
    doc.setFont('helvetica','bold');
    doc.text('‚úÖ Aucun stock critique.', margin, y+5);
    doc.setFont('helvetica','normal');
    y += 12;
  } else {
    alerts.forEach((s, idx) => {
      const lineH = 7;
      if(y + lineH > pageH - 30){ doc.addPage(); y = margin; }
      // bullet
      setRGB(doc.setFillColor, rgb.danger);
      doc.circle(margin+1.5, y+3.2, 1.2, 'F');
      doc.setTextColor(rgb.choc[0],rgb.choc[1],rgb.choc[2]);
      doc.setFont('helvetica','bold');
      doc.text(safeText(s.nom||'Ingr√©dient'), margin+5, y+4.6);
      doc.setFont('helvetica','normal');
      doc.setTextColor(rgb.mocha[0],rgb.mocha[1],rgb.mocha[2]);
      doc.text(`Stock : ${s.qty ?? '‚Äî'} (mini : ${s.seuil ?? '‚Äî'})`, pageW - margin, y+4.6, { align:'right' });
      y += lineH;
    });
    y += 4;
  }

  // Chart snapshot (if available)
  const addChart = () => {
    try{
      const canvas = document.getElementById('caChart');
      if(!canvas || !canvas.toDataURL) return false;
      const dataUrl = canvas.toDataURL('image/png', 1.0);
      if(!dataUrl || dataUrl.length < 200) return false;

      const imgW = pageW - margin*2;
      const imgH = 55;
      if(y + imgH + 18 > pageH - 10){ doc.addPage(); y = margin; }
      sectionTitle('üìà √âvolution du CA (aper√ßu)', y);
      y += 7;
      // frame
      doc.setDrawColor(235, 220, 205);
      doc.roundedRect(margin, y, imgW, imgH, 3, 3, 'S');
      doc.addImage(dataUrl, 'PNG', margin+1, y+1, imgW-2, imgH-2);
      y += imgH + 6;
      return true;
    } catch(e){ return false; }
  };
  addChart();

  // Footer
  const footer = (page) => {
    doc.setFontSize(8);
    doc.setTextColor(140,140,140);
    doc.text('G√©n√©r√© par P√¢tissPro ‚Äî Export PDF optimis√©', margin, pageH - 10);
    doc.text(`Page ${page}`, pageW - margin, pageH - 10, { align:'right' });
  };

  const pages = doc.getNumberOfPages();
  for(let i=1;i<=pages;i++){
    doc.setPage(i);
    footer(i);
  }

  doc.save(`rapport-${(shop||'patisspro').toString().toLowerCase().replace(/\s+/g,'-')}.pdf`);
  ntf('‚úÖ PDF premium g√©n√©r√© !','s');
}

// ============ CHARTS ============
function initCharts() {
  const c1 = g('caChart');
  if(c1 && !caChart) {
    caChart = new Chart(c1, {
      type:'bar',
      data:{
        labels:['Ao√ªt','Sep','Oct','Nov','D√©c','Jan'],
        datasets:[
          {label:'CA', data:[9800,11200,10500,13400,15600,12800], backgroundColor:'rgba(200,135,58,.2)', borderColor:'rgba(200,135,58,.85)', borderWidth:2, borderRadius:8, borderSkipped:false},
          {type:'line', label:'Tendance', data:[9800,11200,10500,13400,15600,12800], borderColor:'rgba(139,94,26,.8)', backgroundColor:'transparent', borderWidth:2, pointBackgroundColor:'rgba(139,94,26,1)', pointRadius:4, tension:.4}
        ]
      },
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{grid:{display:false}}, y:{grid:{color:'rgba(200,135,58,.07)'}, ticks:{callback:v=>v+'‚Ç¨'}}}}
    });
    g('chartlbl').textContent = 'Jan : 12 800 ‚Ç¨';
  }
  const c2 = g('vChart');
  if(c2 && !vChart) {
    const d = vprod();
    vChart = new Chart(c2, {
      type:'doughnut',
      data:{labels:d.l, datasets:[{data:d.v, backgroundColor:['rgba(200,135,58,.85)','rgba(212,168,67,.75)','rgba(122,158,126,.75)','rgba(140,94,60,.75)','rgba(248,200,160,.85)'], borderWidth:2, borderColor:'#FEF9F0'}]},
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom', labels:{font:{family:'DM Sans',size:11},boxWidth:12}}}, cutout:'62%'}
    });
  }
}
function vprod() {
  const m = {};
  S.ventes.forEach(v => { m[v.produit] = (m[v.produit]||0) + v.total; });
  const s = Object.entries(m).sort((a,b)=>b[1]-a[1]);
  return { l: s.map(e=>e[0]), v: s.map(e=>+e[1].toFixed(2)) };
}

// ============ REFRESH ============
function refreshAll() { refreshDB(); renderRecettes(); renderVentes(); renderStocks(); renderEmployes(); renderPrix(); }

// ============ DASHBOARD ============
function refreshDB() {
  const ms = new Date().toISOString().slice(0,7);
  const ca = S.ventes.filter(v=>v.date.startsWith(ms)).reduce((s,v)=>s+v.total, 0);
  g('kca').textContent = fmt(ca);
  g('kmarge').textContent = Math.round(60+Math.random()*5)+'%';
  g('kcout').textContent = fmt(ca*.32);
  g('kprod').textContent = S.recettes.length;

  const pm = {};
  S.ventes.forEach(v => { pm[v.produit]=(pm[v.produit]||0)+v.total; });
  const top = Object.entries(pm).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const mx = top[0]?.[1]||1;
  g('toplist').innerHTML = top.map(([n,c],i) => {
    const w = ((c/mx)*100).toFixed(0);
    return `<div style="margin-bottom:11px"><div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:3px"><span>${['ü•á','ü•à','ü•â','4Ô∏è‚É£','5Ô∏è‚É£'][i]} ${n}</span><strong>${fmt(c)}</strong></div><div class="pb"><div class="pf" style="width:${w}%"></div></div></div>`;
  }).join('');

  const al = S.stocks.filter(s=>s.qty<=s.seuil);
  g('alertlist').innerHTML = al.length === 0
    ? '<p style="color:var(--sage);font-size:13px;text-align:center;padding:18px">‚úÖ Tous les stocks sont OK !</p>'
    : al.map(s => `<div class="sal"><span style="font-size:18px">‚ö†Ô∏è</span><div class="alt"><strong>${s.nom}</strong> ‚Äî Critique : ${s.qty} kg/L (mini : ${s.seuil})</div></div>`).join('');
}



function openRecetteDetail(id){
  const r = S.recettes.find(x => x.id == id);
  if(!r) return;

  g('rdid').value = r.id;
  g('rdnom').value = r.nom || '';
  g('rdcat').value = r.cat || '';
  g('rdcout').value = fmt(r.cout);
  g('rdport').value = (r.portions || 1).toString();
  g('rdtps').value = (r.tps || 0).toString();
  g('rdpv').value = fmt(r.pv);

  g('rdnotes').value = r.notes || '';

  // --- Ingredients breakdown (optional) ---
  const tb = g('rdings');
  if(tb){
    tb.innerHTML = '';
    const ings = Array.isArray(r.ings) ? r.ings : [];
    let totMat = 0;
    if(ings.length){
      ings.forEach(it => {
        const qty = Number(it.qty||0);
        const pu  = Number(it.pu||0); // ‚Ç¨/kg, ‚Ç¨/L, ‚Ç¨/unit√©
        const cost = +(qty * pu).toFixed(4);
        totMat += cost;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="tdb">${it.nom||''}</td>
          <td>${fnum(qty, (qty%1?2:0))}</td>
          <td>${it.unit||''}</td>
          <td>${fmt(pu)}</td>
          <td class="tdb">${fmt(cost)}</td>
        `;
        tb.appendChild(tr);
      });
    } else {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="5" style="color:var(--mocha);font-size:12px;padding:12px 14px">
        Aucun d√©tail ingr√©dient renseign√© pour cette recette.
      </td>`;
      tb.appendChild(tr);
    }
    const rdmat = g('rdmat');
    if(rdmat) rdmat.textContent = fmt(totMat || (r.cout||0));
  }

  const cu = (r.cout || 0) / (r.portions || 1);
  const mg = (r.pv > 0) ? (((r.pv - cu) / r.pv) * 100) : 0;

  g('rdcu').textContent = fmt(cu);
  g('rdmg').textContent = (mg ? Math.round(mg) : 0) + '%';

  openM('mrd');
}


// ============ RECETTES ============
function renderRecettes() {
  const limit = S.plan==='free' ? 5 : 999;
  const html = S.recettes.slice(0,limit).map(r => {
    const cu = r.cout/r.portions;
    const mg = r.pv>0 ? +((r.pv-cu)/r.pv*100).toFixed(0) : 0;
    const mc = mg>65?'tg':mg>45?'to':'tr';
    return `<div class="rcc" data-open-r="${r.id}">
      <h4>${r.nom}</h4>
      <div class="rr"><span class="rl">Cat√©gorie</span><span class="tag to">${r.cat}</span></div>
      <div class="rr"><span class="rl">Co√ªt mati√®res</span><span class="rv">${fmt(r.cout)}</span></div>
      <div class="rr"><span class="rl">Co√ªt / portion</span><span class="rv">${fmt(cu)}</span></div>
      <div class="rr"><span class="rl">Prix de vente</span><span class="rv">${fmt(r.pv)}</span></div>
      <div class="rr"><span class="rl">Marge</span><span class="tag ${mc}">${mg}%</span></div>
      <div class="pb"><div class="pf" style="width:${Math.min(mg,100)}%"></div></div>
      <div style="display:flex;gap:6px;margin-top:10px">
        <button class="btn btnd bsm" data-del-r="${r.id}">üóëÔ∏è Supprimer</button>
      </div>
    </div>`;
  }).join('');

  const lockedCard = (S.plan==='free' && S.recettes.length>=5)
    ? `<div class="card" style="display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:28px;border:2px dashed var(--caramel);background:var(--cream)">
        <span style="font-size:30px">üîí</span>
        <p style="margin:10px 0;font-size:13px;color:var(--mocha)">Limite de 5 recettes atteinte</p>
        <button class="btn btnp bsm" data-page="abonnement">Passer √† Pro ‚Üí</button>
      </div>` : '';

  g('rgrid').innerHTML = html + lockedCard;

  // Attach delete listeners
  g('rgrid').querySelectorAll('[data-del-r]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      S.recettes = S.recettes.filter(r => r.id != btn.dataset.delR);
      renderRecettes();
      ntf('Recette supprim√©e');
    });
  // Open detail on card click
  g('rgrid').querySelectorAll('[data-open-r]').forEach(card => {
    card.addEventListener('click', () => openRecetteDetail(card.dataset.openR));
  });

  });
  // Attach nav listeners on locked card
  g('rgrid').querySelectorAll('[data-page]').forEach(el => {
    el.addEventListener('click', () => showPage(el.dataset.page, null));
  });

  // Populate vente select
  const sel = g('vprod');
  sel.innerHTML = '<option value="">S√©lectionner...</option>' + S.recettes.map(r => `<option value="${r.id}" data-prix="${r.pv}">${r.nom}</option>`).join('');
  calcRecette();
}

function openNewRecette() {
  if(S.plan==='free' && S.recettes.length>=5) { showPage('abonnement',null); return; }
  openM('mr');
}

function saveR() {
  const nom = g('rnom').value;
  if(!nom){ ntf('Nom requis','e');   saveState();
return; }
  S.recettes.push({
    id: Date.now(), nom,
    cat: g('rcat').value,
    cout: +g('rcout').value||0,
    portions: +g('rport').value||1,
    tps: +g('rtps').value||0,
    pv: +g('rpv').value||0,
    notes: g('rnotes').value
  });
  closeM('mr');
  renderRecettes();
  ntf('‚úÖ Recette enregistr√©e !', 's');
  ['rnom','rcout','rport','rtps','rpv','rnotes'].forEach(id => { if(g(id)) g(id).value=''; });
}

// ============ CALCULATRICE ============
function addIng() {
  const c = g('ingc');
  const d = document.createElement('div');
  d.className = 'ir';
  d.innerHTML = `
    <input type="text" placeholder="Ex: Farine T45">
    <input type="number" placeholder="250" min="0" step="any">
    <select><option value="g">g</option><option value="kg">kg</option><option value="cl">cl</option><option value="L">L</option><option value="piece">pi√®ce</option></select>
    <input type="number" placeholder="Prix/kg" min="0" step="0.01">
    <button class="btnrm">‚úï</button>`;
  d.querySelector('.btnrm').addEventListener('click', () => { d.remove(); calcRecette(); });
  d.querySelectorAll('input,select').forEach(el => el.addEventListener('input', calcRecette));
  c.appendChild(d);
}

function calcRecette() {
  let cm = 0;
  document.querySelectorAll('#ingc .ir').forEach(row => {
    const ins = row.querySelectorAll('input');
    const sel = row.querySelector('select');
    const qty=+ins[1]?.value||0, unit=sel?.value, px=+ins[2]?.value||0;
    let q = qty;
    if(unit==='g') q=qty/1000;
    else if(unit==='cl') q=qty/100;
    cm += q*px;
  });
  const pieces=+g('npieces').value||1, tps=+g('ttravail').value||0, tx=+g('couth').value||0;
  const mo=(tps/60)*tx, tot=cm+mo, pp=tot/pieces;
  g('rmat').textContent=fmt(cm);
  g('rmo').textContent=fmt(mo);
  g('rpc').textContent=fmt(pp);
  g('rsug').textContent=fmt(pp*3);
}

// ============ PRIX ============
function calcPrix() {
  const cout=+g('pcout').value||0, marge=+g('pmarge').value||60, tva=+g('ptva').value||5.5;
  if(cout<=0) return;
  const ht=cout/(1-marge/100), tvaM=ht*(tva/100), ttc=ht+tvaM;
  g('rht').textContent=fmt(ht);
  g('rtva').textContent=fmt(tvaM);
  g('rttc').textContent=fmt(ttc);
  g('rmn').textContent=fmt(ht-cout);
}

function calcSeuil() {
  const f=+g('srfix').value||0, v=+g('srvar').value||0, p=+g('srpv').value||0;
  const mc=p-v;
  if(mc<=0){ g('seuilv').textContent='‚àû'; return; }
  const s=Math.ceil(f/mc);
  g('seuilv').textContent=s.toLocaleString('fr-FR');
  g('seuilca').textContent=fmt(s*p);
}

function renderPrix() {
  calcPrix(); calcSeuil();
  g('prixtb').innerHTML = S.recettes.map(r => {
    const cu=r.cout/r.portions, mg=r.pv>0?+((r.pv-cu)/r.pv*100).toFixed(0):0;
    const me=r.pv-cu, vol=Math.floor(Math.random()*200)+20, ca=vol*r.pv;
    const rc=mg>60?'tg':mg>40?'to':'tr';
    return `<tr><td class="tdb">${r.nom}</td><td>${fmt(cu)}</td><td>${fmt(r.pv)}</td><td><span class="tag ${rc}">${mg}%</span></td><td>${fmt(me)}</td><td>${vol}</td><td>${fmt(ca)}</td><td><span class="tag ${rc}">${mg>60?'Excellente':mg>40?'Correcte':'√Ä am√©liorer'}</span></td></tr>`;
  }).join('');
}

// ============ VENTES ============
function renderVentes() {
  const now=new Date(), ts=now.toISOString().split('T')[0], ms=now.toISOString().slice(0,7);
  const ws=new Date(now); ws.setDate(now.getDate()-7);
  const tv=S.ventes.filter(v=>v.date===ts), wv=S.ventes.filter(v=>new Date(v.date)>=ws), mv=S.ventes.filter(v=>v.date.startsWith(ms));
  g('vtoday').textContent=fmt(tv.reduce((s,v)=>s+v.total,0));
  g('vnb').textContent=tv.length;
  g('vweek').textContent=fmt(wv.reduce((s,v)=>s+v.total,0));
  g('vmonth').textContent=fmt(mv.reduce((s,v)=>s+v.total,0));
  g('vpanier').textContent=S.ventes.length ? fmt(S.ventes.reduce((s,v)=>s+v.total,0)/S.ventes.length) : fmt(0);

  const icons = {'Tarte Citron Meringu√©e':'üçã','Croissant au Beurre':'ü•ê','Eclair au Chocolat':'üç´','Entremet Framboise':'üçì','Madeleine Maison':'üßÅ'};
  g('vlist').innerHTML = [...S.ventes].sort((a,b)=>b.date.localeCompare(a.date)).slice(0,12).map(v =>
    `<div class="vr"><span style="font-size:26px">${icons[v.produit]||'üéÇ'}</span><div class="vi"><div class="vn">${v.produit} √ó${v.qty}</div><div class="vd">${fd(v.date)} ¬∑ ${v.canal}</div></div><span class="va">+${fmt(v.total)}</span></div>`
  ).join('');

  if(vChart){ const d=vprod(); vChart.data.labels=d.l; vChart.data.datasets[0].data=d.v; vChart.update(); }
}

function updVTot() {
  const q=+g('vqty').value||1, p=+g('vprix').value||0;
  g('vtot').textContent = p ? fmt(q*p) : '‚Äî';
}

function saveV() {
  const pid=g('vprod').value, qty=+g('vqty').value||1, prix=+g('vprix').value||0;
  const date=g('vdate').value, canal=g('vcanal').value;
  const r=S.recettes.find(r=>r.id==pid);
  if(!r||!prix){ ntf('S√©lectionnez un produit et un prix','e');   saveState();
return; }
  S.ventes.unshift({id:Date.now(), produit:r.nom, qty, prix, date, total:+(qty*prix).toFixed(2), canal});
  closeM('mv');
  renderVentes();
  refreshDB();
  ntf('‚úÖ Vente enregistr√©e !', 's');
}

// ============ STOCKS ============
function renderStocks() {
  const al=S.stocks.filter(s=>s.qty<=s.seuil).length, val=S.stocks.reduce((s,x)=>s+x.qty*x.prix,0);
  g('stval').textContent=fmt(val);
  g('stal').textContent=al;
  g('sttot').textContent=S.stocks.length;
  g('sttb').innerHTML = S.stocks.map(s => {
    const st=s.qty<=0?['tr','Rupture']:s.qty<=s.seuil?['tr','Critique']:s.qty<=s.seuil*1.5?['to','Faible']:['tg','OK'];
    return `<tr><td class="tdb">${s.nom}</td><td><span class="tag to">${s.cat}</span></td><td>${s.qty} kg/L</td><td>${s.seuil}</td><td>${fmt(s.prix)}</td><td>${fmt(s.qty*s.prix)}</td><td><span class="tag ${st[0]}">${st[1]}</span></td><td style="white-space:nowrap"><button class="btn btno bsm" data-edit-s="${s.id}">‚úèÔ∏è</button> <button class="btn btnd bsm" data-del-s="${s.id}">üóëÔ∏è</button></td></tr>`;
  }).join('');

  g('sttb').querySelectorAll('[data-edit-s]').forEach(btn => {
    btn.addEventListener('click', () => editStock(+btn.dataset.editS));
  });
  g('sttb').querySelectorAll('[data-del-s]').forEach(btn => {
    btn.addEventListener('click', () => { S.stocks=S.stocks.filter(s=>s.id!=btn.dataset.delS); renderStocks(); ntf('Ingr√©dient supprim√©'); });
  });
}

function clearStockForm() {
  ['snom','sqty','sseuil','sprix','sfourn'].forEach(id => { if(g(id)) g(id).value=''; });
}

function editStock(id) {
  const s = S.stocks.find(x=>x.id===id);
  if(!s) return;
  g('seid').value = id;
  g('snom').value=s.nom; g('scat').value=s.cat; g('sqty').value=s.qty;
  g('sseuil').value=s.seuil; g('sprix').value=s.prix; g('sfourn').value=s.fourn;
  openM('ms');
}

function saveS() {
  const nom = g('snom').value;
  if(!nom){ ntf('Nom requis','e');   saveState();
return; }
  const eid = +g('seid').value||0;
  const s = {id:eid||Date.now(), nom, cat:g('scat').value, qty:+g('sqty').value||0, seuil:+g('sseuil').value||0, prix:+g('sprix').value||0, fourn:g('sfourn').value};
  if(eid){ const i=S.stocks.findIndex(x=>x.id===eid); if(i>=0) S.stocks[i]=s; }
  else S.stocks.push(s);
  closeM('ms');
  renderStocks();
  ntf('‚úÖ Stock mis √† jour !', 's');
}

// ============ EMPLOY√âS ============
function renderEmployes() {
  const ms=S.employes.reduce((s,e)=>s+e.sal*1.42,0), th=S.employes.reduce((s,e)=>s+e.h*4.33,0), ch=th>0?ms/th:0;
  g('emasse').textContent=fmt(ms);
  g('ehm').textContent=Math.round(th)+'h';
  g('echm').textContent=fmt(ch);
  g('elist').innerHTML = S.employes.map(e => {
    const ini = e.nom.split(' ').map(n=>n[0]).join('').toUpperCase();
    return `<div class="ec"><div class="eav">${ini}</div><div class="ei"><div class="en">${e.nom}</div><div class="er">${e.poste} ¬∑ ${e.contrat}</div></div><div class="es"><div class="eh">${e.h}h/sem</div><div class="ec2">${fmt(e.sal*1.42)}/mois</div></div><button class="btn btnd bsm" data-del-e="${e.id}">üóëÔ∏è</button></div>`;
  }).join('');

  g('elist').querySelectorAll('[data-del-e]').forEach(btn => {
    btn.addEventListener('click', () => { S.employes=S.employes.filter(e=>e.id!=btn.dataset.delE); renderEmployes(); ntf('Employ√© supprim√©'); });
  });

  const sel = g('semp');
  sel.innerHTML = '<option value="">S√©lectionner...</option>' + S.employes.map(e=>`<option value="${e.id}">${e.nom}</option>`).join('');
}

function saveE() {
  const nom = g('enom').value;
  if(!nom){ ntf('Nom requis','e');   saveState();
return; }
  S.employes.push({id:Date.now(), nom, poste:g('eposte').value, sal:+g('esal').value||0, h:+g('ehw').value||35, date:g('edate').value, contrat:g('econtrat').value});
  closeM('me');
  renderEmployes();
  ntf('‚úÖ Employ√© ajout√© !', 's');
  g('enom').value = '';
}

function saisirH() {
  const eid=g('semp').value, date=g('sdate').value, h=+g('sheures').value||0, type=g('stype').value;
  if(!eid||!date||!h){ ntf('Remplissez tous les champs','e');   saveState();
return; }
  S.heures.push({empId:eid, date, heures:h, type});
  const e = S.employes.find(e=>e.id==eid);
  ntf(`‚úÖ ${h}h enregistr√©es pour ${e?.nom||"l'employ√©"}`, 's');
}

// ============ RAPPORTS ============
function renderRap() {
  const caT = S.ventes.reduce((s,v)=>s+v.total,0);
  const el = g('rapc');
  el.innerHTML = '';

  // Tab switcher
  const tsw = document.createElement('div');
  tsw.className = 'tsw';
  ['Par Produit','Par Canal','Mensuel'].forEach((lbl,i) => {
    const b = document.createElement('button');
    b.className = 'tbtn' + (i===0?' active':'');
    b.textContent = lbl;
    b.addEventListener('click', () => { tsw.querySelectorAll('.tbtn').forEach(x=>x.classList.remove('active')); b.classList.add('active'); });
    tsw.appendChild(b);
  });
  el.appendChild(tsw);

  // KPIs
  const kpis = document.createElement('div');
  kpis.className = 'cg g3';
  kpis.style.marginBottom = '20px';
  kpis.innerHTML = `
    <div class="kpi"><span class="kico">üí∂</span><div class="klbl">CA Total Historique</div><div class="kval">${fmt(caT)}</div><div class="ksub">${S.ventes.length} transactions</div></div>
    <div class="kpi"><span class="kico">üìà</span><div class="klbl">Marge Brute Moy.</div><div class="kval">63%</div><div class="ksub pos">‚Üë Tr√®s bonne performance</div></div>
    <div class="kpi"><span class="kico">ü•á</span><div class="klbl">Meilleur Produit</div><div class="kval">ü•ê</div><div class="ksub">Croissant au Beurre</div></div>`;
  el.appendChild(kpis);

  // Table
  const tc = document.createElement('div');
  tc.className = 'card';
  tc.style.marginBottom = '20px';
  const rows = S.recettes.map(r => {
    const vv=S.ventes.filter(x=>x.produit===r.nom), ca=vv.reduce((s,x)=>s+x.total,0), u=vv.reduce((s,x)=>s+x.qty,0);
    const ct=u*(r.cout/r.portions), mg=ca-ct, mp=ca>0?+((mg/ca)*100).toFixed(0):0;
    const rc=mp>60?'tg':mp>40?'to':'tr';
    return `<tr><td class="tdb">${r.nom}</td><td>${u}</td><td>${fmt(ca)}</td><td>${fmt(ct)}</td><td>${fmt(mg)}</td><td><span class="tag ${rc}">${mp}%</span></td></tr>`;
  }).join('');
  tc.innerHTML = `<div class="st">üìä Rentabilit√© par Produit</div><div class="tw"><table><thead><tr><th>Produit</th><th>Unit√©s</th><th>CA</th><th>Co√ªt</th><th>Marge</th><th>%</th></tr></thead><tbody>${rows}</tbody></table></div>`;
  el.appendChild(tc);

  // Export
  const exp = document.createElement('div');
  exp.className = 'card';
  exp.innerHTML = '<div class="st">üì• Exporter les Donn√©es</div><div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:4px"></div>';
  const btnsDiv = exp.querySelector('div div');

  // Export : uniquement PDF optimis√© (Plan Pro)
  const b = document.createElement('button');
  b.className = 'btn btnp';
  b.textContent = 'üìÑ Export PDF optimis√©';
  b.addEventListener('click', exportPDF);
  btnsDiv.appendChild(b);

  el.appendChild(exp);
}
// ============ PR√âVISIONS ============
function renderPrev() {
  const el = g('prevc');
  el.innerHTML = '';

  const kpis = document.createElement('div');
  kpis.className = 'cg g3';
  kpis.style.marginBottom = '20px';
  kpis.innerHTML = `
    <div class="kpi"><span class="kico">üîÆ</span><div class="klbl">Pr√©vision CA Mois Prochain</div><div class="kval">14 200 ‚Ç¨</div><div class="ksub pos">‚Üë +11% estim√©</div></div>
    <div class="kpi"><span class="kico">üìÖ</span><div class="klbl">Meilleure P√©riode</div><div class="kval">Dim-Lun</div><div class="ksub">Pic de ventes pr√©vu</div></div>
    <div class="kpi"><span class="kico">‚ö†Ô∏è</span><div class="klbl">Risque Surstock</div><div class="kval" style="font-size:18px;color:var(--caramel)">Mod√©r√©</div><div class="ksub neg">Beurre & cr√®me</div></div>`;
  el.appendChild(kpis);

  const sem = document.createElement('div');
  sem.className = 'card';
  sem.style.marginBottom = '20px';
  const semRows = [['Sem. 1',3420,'+8%',true],['Sem. 2',3890,'+15%',true],['Sem. 3',4120,'+21%',true],['Sem. 4',2760,'-18%',false]];
  sem.innerHTML = `<div class="st">üìÜ Pr√©visions ‚Äî 4 Semaines</div><div class="cg g4">${semRows.map(([s,v,c,p])=>`<div class="kpi"><div class="klbl">${s}</div><div class="kval">${fmt(v)}</div><div class="ksub ${p?'pos':'neg'}">${c} vs sem. pass√©e</div></div>`).join('')}</div>`;
  el.appendChild(sem);

  const reco = document.createElement('div');
  reco.className = 'card';
  reco.innerHTML = `<div class="st">üì¶ Recommandations de Production</div><p style="color:var(--mocha);font-size:13px;margin-bottom:14px">Bas√©es sur votre historique et saisonnalit√© :</p>${
    S.recettes.map(r => `<div style="display:flex;align-items:center;gap:14px;padding:11px;background:var(--cream);border-radius:9px;margin-bottom:7px"><span style="font-size:26px">üéÇ</span><div style="flex:1"><div style="font-weight:600;font-size:13px">${r.nom}</div><div style="font-size:11px;color:var(--mocha)">${r.cat}</div></div><div style="text-align:right"><div style="font-size:17px;font-weight:700;color:var(--cd)">${Math.floor(Math.random()*30+15)} u/jour</div><div style="font-size:10px;color:var(--mocha)">recommand√©</div></div></div>`).join('')}`;
  el.appendChild(reco);
}


</script>
</body>
</html>
